
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Space-time analysis Â· Geographic Data Science with PySAL and the pydata stack</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex-dev/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../content/part2/" />
    
    
    <link rel="prev" href="04_esda.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../distribution.html">
            
                <a href="../distribution.html">
            
                    
                    Distribution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../content/about.html">
            
                <a href="../content/about.html">
            
                    
                    About the authors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../content/infrastructure/">
            
                <a href="../content/infrastructure/">
            
                    
                    Install guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../content/outline.html">
            
                <a href="../content/outline.html">
            
                    
                    Outline
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../content/data/">
            
                <a href="../content/data/">
            
                    
                    Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../content/part1/">
            
                <a href="../content/part1/">
            
                    
                    Part I
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="01_data_processing.html">
            
                <a href="01_data_processing.html">
            
                    
                    Spatial data processing with PySAL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="02_geovisualization.html">
            
                <a href="02_geovisualization.html">
            
                    
                    Geovisualization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="03_spatial_weights.html">
            
                <a href="03_spatial_weights.html">
            
                    
                    Spatial weights in PySAL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="04_esda.html">
            
                <a href="04_esda.html">
            
                    
                    ESDA with PySAL
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7.5" data-path="05_spatial_dynamics.html">
            
                <a href="05_spatial_dynamics.html">
            
                    
                    Space-time analysis
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../content/part2/">
            
                <a href="../content/part2/">
            
                    
                    Part II
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="06_points.html">
            
                <a href="06_points.html">
            
                    
                    Points
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="07_spatial_clustering.html">
            
                <a href="07_spatial_clustering.html">
            
                    
                    Spatial clustering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="08_spatial_regression.html">
            
                <a href="08_spatial_regression.html">
            
                    
                    Spatial Regression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../content/infrastructure/workflow.html">
            
                <a href="../content/infrastructure/workflow.html">
            
                    
                    Development notes
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Space-time analysis</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="exploratory-spatial-and-temporal-data-analysis-estda">Exploratory Spatial and Temporal Data Analysis (ESTDA)</h1>
<blockquote>
<p><a href="../content/part1/05_spatial_dynamics.ipynb"><code>IPYNB</code></a></p>
</blockquote>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> matplotlib
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pysal <span class="hljs-keyword">as</span> ps
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
%matplotlib inline
</code></pre>
<pre><code class="lang-python">f = ps.open(ps.examples.get_path(<span class="hljs-string">&apos;usjoin.csv&apos;</span>), <span class="hljs-string">&apos;r&apos;</span>)
</code></pre>
<p>To determine what is in the file, check the <code>header</code> attribute on the file object:</p>
<pre><code class="lang-python">f.header[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[&apos;Name&apos;,
 &apos;STATE_FIPS&apos;,
 &apos;1929&apos;,
 &apos;1930&apos;,
 &apos;1931&apos;,
 &apos;1932&apos;,
 &apos;1933&apos;,
 &apos;1934&apos;,
 &apos;1935&apos;,
 &apos;1936&apos;]
</code></pre><p>Ok, lets pull in the <code>name</code> variable to see what we have.</p>
<pre><code class="lang-python">name = f.by_col(<span class="hljs-string">&apos;Name&apos;</span>)
</code></pre>
<pre><code class="lang-python">name
</code></pre>
<pre><code>[&apos;Alabama&apos;,
 &apos;Arizona&apos;,
 &apos;Arkansas&apos;,
 &apos;California&apos;,
 &apos;Colorado&apos;,
 &apos;Connecticut&apos;,
 &apos;Delaware&apos;,
 &apos;Florida&apos;,
 &apos;Georgia&apos;,
 &apos;Idaho&apos;,
 &apos;Illinois&apos;,
 &apos;Indiana&apos;,
 &apos;Iowa&apos;,
 &apos;Kansas&apos;,
 &apos;Kentucky&apos;,
 &apos;Louisiana&apos;,
 &apos;Maine&apos;,
 &apos;Maryland&apos;,
 &apos;Massachusetts&apos;,
 &apos;Michigan&apos;,
 &apos;Minnesota&apos;,
 &apos;Mississippi&apos;,
 &apos;Missouri&apos;,
 &apos;Montana&apos;,
 &apos;Nebraska&apos;,
 &apos;Nevada&apos;,
 &apos;New Hampshire&apos;,
 &apos;New Jersey&apos;,
 &apos;New Mexico&apos;,
 &apos;New York&apos;,
 &apos;North Carolina&apos;,
 &apos;North Dakota&apos;,
 &apos;Ohio&apos;,
 &apos;Oklahoma&apos;,
 &apos;Oregon&apos;,
 &apos;Pennsylvania&apos;,
 &apos;Rhode Island&apos;,
 &apos;South Carolina&apos;,
 &apos;South Dakota&apos;,
 &apos;Tennessee&apos;,
 &apos;Texas&apos;,
 &apos;Utah&apos;,
 &apos;Vermont&apos;,
 &apos;Virginia&apos;,
 &apos;Washington&apos;,
 &apos;West Virginia&apos;,
 &apos;Wisconsin&apos;,
 &apos;Wyoming&apos;]
</code></pre><p>Now obtain per capital incomes in 1929 which is in the column associated with <code>1929</code>.</p>
<pre><code class="lang-python">y1929 = f.by_col(<span class="hljs-string">&apos;1929&apos;</span>)
</code></pre>
<pre><code class="lang-python">y1929[:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[323, 600, 310, 991, 634, 1024, 1032, 518, 347, 507]
</code></pre><p>And now 2009</p>
<pre><code class="lang-python">y2009 = f.by_col(<span class="hljs-string">&quot;2009&quot;</span>)
</code></pre>
<pre><code class="lang-python">y2009[:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[32274, 32077, 31493, 40902, 40093, 52736, 40135, 36565, 33086, 30987]
</code></pre><p>These are read into regular Python lists which are not particularly well suited to efficient data analysis. So let&apos;s convert them to numpy arrays.</p>
<pre><code class="lang-python">y2009 = np.array(y2009)
</code></pre>
<pre><code class="lang-python">y2009
</code></pre>
<pre><code>array([32274, 32077, 31493, 40902, 40093, 52736, 40135, 36565, 33086,
       30987, 40933, 33174, 35983, 37036, 31250, 35151, 35268, 47159,
       49590, 34280, 40920, 29318, 35106, 32699, 37057, 38009, 41882,
       48123, 32197, 46844, 33564, 38672, 35018, 33708, 35210, 38827,
       41283, 30835, 36499, 33512, 35674, 30107, 36752, 43211, 40619,
       31843, 35676, 42504])
</code></pre><p>Much better. But pulling these in and converting them a column at a time is tedious and error prone. So we will do all of this in a list comprehension.</p>
<pre><code class="lang-python">Y = np.array( [ f.by_col(str(year)) <span class="hljs-keyword">for</span> year <span class="hljs-keyword">in</span> range(<span class="hljs-number">1929</span>,<span class="hljs-number">2010</span>) ] ) * <span class="hljs-number">1.0</span>
</code></pre>
<pre><code class="lang-python">Y.shape
</code></pre>
<pre><code>(81, 48)
</code></pre><pre><code class="lang-python">Y = Y.transpose()
</code></pre>
<pre><code class="lang-python">Y.shape
</code></pre>
<pre><code>(48, 81)
</code></pre><pre><code class="lang-python">years = np.arange(<span class="hljs-number">1929</span>,<span class="hljs-number">2010</span>)
</code></pre>
<pre><code class="lang-python">plt.plot(years,Y[<span class="hljs-number">0</span>])
</code></pre>
<pre><code>[&lt;matplotlib.lines.Line2D at 0x110ba1a58&gt;]
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_23_1.png" alt="png"></p>
<pre><code class="lang-python">RY = Y / Y.mean(axis=<span class="hljs-number">0</span>)
</code></pre>
<pre><code class="lang-python">plt.plot(years,RY[<span class="hljs-number">0</span>])
</code></pre>
<pre><code>[&lt;matplotlib.lines.Line2D at 0x113575e10&gt;]
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_25_1.png" alt="png"></p>
<pre><code class="lang-python">name = np.array(name)
</code></pre>
<pre><code class="lang-python">np.nonzero(name==<span class="hljs-string">&apos;Ohio&apos;</span>)
</code></pre>
<pre><code>(array([32]),)
</code></pre><pre><code class="lang-python">plt.plot(years, RY[<span class="hljs-number">32</span>], label=<span class="hljs-string">&apos;Ohio&apos;</span>)
plt.plot(years, RY[<span class="hljs-number">0</span>], label=<span class="hljs-string">&apos;Alabama&apos;</span>)
plt.legend()
</code></pre>
<pre><code>&lt;matplotlib.legend.Legend at 0x1137d9eb8&gt;
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_28_1.png" alt="png"></p>
<h2 id="spaghetti-plot">Spaghetti Plot</h2>
<pre><code class="lang-python"><span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> RY:
    plt.plot(years, row)
</code></pre>
<p><img src="05_spatial_dynamics_files/05_spatial_dynamics_30_0.png" alt="png"></p>
<h2 id="kernel-density-univariate-aspatial">Kernel Density (univariate, aspatial)</h2>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> scipy.stats.kde <span class="hljs-keyword">import</span> gaussian_kde
</code></pre>
<pre><code class="lang-python">density = gaussian_kde(Y[:,<span class="hljs-number">0</span>])
</code></pre>
<pre><code class="lang-python">Y[:,<span class="hljs-number">0</span>]
</code></pre>
<pre><code>array([  323.,   600.,   310.,   991.,   634.,  1024.,  1032.,   518.,
         347.,   507.,   948.,   607.,   581.,   532.,   393.,   414.,
         601.,   768.,   906.,   790.,   599.,   286.,   621.,   592.,
         596.,   868.,   686.,   918.,   410.,  1152.,   332.,   382.,
         771.,   455.,   668.,   772.,   874.,   271.,   426.,   378.,
         479.,   551.,   634.,   434.,   741.,   460.,   673.,   675.])
</code></pre><pre><code class="lang-python">density = gaussian_kde(Y[:,<span class="hljs-number">0</span>])
</code></pre>
<pre><code class="lang-python">minY0 = Y[:,<span class="hljs-number">0</span>].min()*<span class="hljs-number">.90</span>
maxY0 = Y[:,<span class="hljs-number">0</span>].max()*<span class="hljs-number">1.10</span>
x = np.linspace(minY0, maxY0, <span class="hljs-number">100</span>)
</code></pre>
<pre><code class="lang-python">plt.plot(x,density(x))
</code></pre>
<pre><code>[&lt;matplotlib.lines.Line2D at 0x113d2a748&gt;]
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_37_1.png" alt="png"></p>
<pre><code class="lang-python">d2009 = gaussian_kde(Y[:,<span class="hljs-number">-1</span>])
</code></pre>
<pre><code class="lang-python">minY0 = Y[:,<span class="hljs-number">-1</span>].min()*<span class="hljs-number">.90</span>
maxY0 = Y[:,<span class="hljs-number">-1</span>].max()*<span class="hljs-number">1.10</span>
x = np.linspace(minY0, maxY0, <span class="hljs-number">100</span>)
</code></pre>
<pre><code class="lang-python">plt.plot(x,d2009(x))
</code></pre>
<pre><code>[&lt;matplotlib.lines.Line2D at 0x113a48358&gt;]
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_40_1.png" alt="png"></p>
<pre><code class="lang-python">minR0 = RY.min()
</code></pre>
<pre><code class="lang-python">maxR0 = RY.max()
</code></pre>
<pre><code class="lang-python">x = np.linspace(minR0, maxR0, <span class="hljs-number">100</span>)
</code></pre>
<pre><code class="lang-python">d1929 = gaussian_kde(RY[:,<span class="hljs-number">0</span>])
</code></pre>
<pre><code class="lang-python">d2009 = gaussian_kde(RY[:,<span class="hljs-number">-1</span>])
</code></pre>
<pre><code class="lang-python">plt.plot(x, d1929(x))
plt.plot(x, d2009(x))
</code></pre>
<pre><code>[&lt;matplotlib.lines.Line2D at 0x113d035c0&gt;]
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_46_1.png" alt="png"></p>
<pre><code class="lang-python">plt.plot(x, d1929(x), label=<span class="hljs-string">&apos;1929&apos;</span>)
plt.plot(x, d2009(x), label=<span class="hljs-string">&apos;2009&apos;</span>)
plt.legend()
</code></pre>
<pre><code>&lt;matplotlib.legend.Legend at 0x113a4a908&gt;
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_47_1.png" alt="png"></p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> range(<span class="hljs-number">2010</span><span class="hljs-number">-1929</span>):
    sns.kdeplot(RY[:,y])
<span class="hljs-comment">#sns.kdeplot(data.HR80)</span>
<span class="hljs-comment">#sns.kdeplot(data.HR70)</span>
<span class="hljs-comment">#sns.kdeplot(data.HR60)</span>
</code></pre>
<pre><code>/Users/dani/anaconda/envs/gds-scipy16/lib/python3.5/site-packages/statsmodels/nonparametric/kdetools.py:20: VisibleDeprecationWarning: using a non-integer number instead of an integer will result in an error in the future
  y = X[:m/2+1] + np.r_[0,X[m/2+1:],0]*1j
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_48_1.png" alt="png"></p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> range(<span class="hljs-number">2010</span><span class="hljs-number">-1929</span>):
    sns.kdeplot(RY[:,y])
</code></pre>
<pre><code>/Users/dani/anaconda/envs/gds-scipy16/lib/python3.5/site-packages/statsmodels/nonparametric/kdetools.py:20: VisibleDeprecationWarning: using a non-integer number instead of an integer will result in an error in the future
  y = X[:m/2+1] + np.r_[0,X[m/2+1:],0]*1j
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_49_1.png" alt="png"></p>
<pre><code class="lang-python"><span class="hljs-keyword">for</span> cs <span class="hljs-keyword">in</span> RY.T: <span class="hljs-comment"># take cross sections</span>
    plt.plot(x, gaussian_kde(cs)(x))
</code></pre>
<p><img src="05_spatial_dynamics_files/05_spatial_dynamics_50_0.png" alt="png"></p>
<pre><code class="lang-python">cs[<span class="hljs-number">0</span>]
</code></pre>
<pre><code>0.86746356478544273
</code></pre><pre><code class="lang-python">sigma = RY.std(axis=<span class="hljs-number">0</span>)
plt.plot(years, sigma)
plt.ylabel(<span class="hljs-string">&apos;s&apos;</span>)
plt.xlabel(<span class="hljs-string">&apos;year&apos;</span>)
plt.title(<span class="hljs-string">&quot;Sigma-Convergence&quot;</span>)
</code></pre>
<pre><code>&lt;matplotlib.text.Text at 0x11439c470&gt;
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_52_1.png" alt="png"></p>
<p>So the distribution is becoming less dispersed over time.</p>
<p>But what about internal mixing? Do poor (rich) states remain poor (rich), or is there movement within the distribuiton over time?</p>
<h2 id="markov-chains">Markov Chains</h2>
<pre><code class="lang-python">c = np.array([
[<span class="hljs-string">&apos;b&apos;</span>,<span class="hljs-string">&apos;a&apos;</span>,<span class="hljs-string">&apos;c&apos;</span>],
[<span class="hljs-string">&apos;c&apos;</span>,<span class="hljs-string">&apos;c&apos;</span>,<span class="hljs-string">&apos;a&apos;</span>],
[<span class="hljs-string">&apos;c&apos;</span>,<span class="hljs-string">&apos;b&apos;</span>,<span class="hljs-string">&apos;c&apos;</span>],
[<span class="hljs-string">&apos;a&apos;</span>,<span class="hljs-string">&apos;a&apos;</span>,<span class="hljs-string">&apos;b&apos;</span>],
[<span class="hljs-string">&apos;a&apos;</span>,<span class="hljs-string">&apos;b&apos;</span>,<span class="hljs-string">&apos;c&apos;</span>]])
</code></pre>
<pre><code class="lang-python">c
</code></pre>
<pre><code>array([[&apos;b&apos;, &apos;a&apos;, &apos;c&apos;],
       [&apos;c&apos;, &apos;c&apos;, &apos;a&apos;],
       [&apos;c&apos;, &apos;b&apos;, &apos;c&apos;],
       [&apos;a&apos;, &apos;a&apos;, &apos;b&apos;],
       [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;]], 
      dtype=&apos;&lt;U1&apos;)
</code></pre><pre><code class="lang-python">m = ps.Markov(c)
</code></pre>
<pre><code class="lang-python">m.classes
</code></pre>
<pre><code>array([&apos;a&apos;, &apos;b&apos;, &apos;c&apos;], 
      dtype=&apos;&lt;U1&apos;)
</code></pre><pre><code class="lang-python">m.transitions
</code></pre>
<pre><code>array([[ 1.,  2.,  1.],
       [ 1.,  0.,  2.],
       [ 1.,  1.,  1.]])
</code></pre><pre><code class="lang-python">m.p
</code></pre>
<pre><code>matrix([[ 0.25      ,  0.5       ,  0.25      ],
        [ 0.33333333,  0.        ,  0.66666667],
        [ 0.33333333,  0.33333333,  0.33333333]])
</code></pre><h3 id="state-per-capita-incomes">State Per Capita Incomes</h3>
<pre><code class="lang-python">ps.examples.explain(<span class="hljs-string">&apos;us_income&apos;</span>)
</code></pre>
<pre><code>{&apos;description&apos;: &apos;Per-capita income for the lower 47 US states 1929-2010&apos;,
 &apos;explanation&apos;: [&apos; * us48.shp: shapefile &apos;,
  &apos; * us48.dbf: dbf for shapefile&apos;,
  &apos; * us48.shx: index for shapefile&apos;,
  &apos; * usjoin.csv: attribute data (comma delimited file)&apos;],
 &apos;name&apos;: &apos;us_income&apos;}
</code></pre><pre><code class="lang-python">data = ps.pdio.read_files(ps.examples.get_path(<span class="hljs-string">&quot;us48.dbf&quot;</span>))
W = ps.queen_from_shapefile(ps.examples.get_path(<span class="hljs-string">&quot;us48.shp&quot;</span>))
W.transform = <span class="hljs-string">&apos;r&apos;</span>
</code></pre>
<pre><code class="lang-python">data.STATE_NAME
</code></pre>
<pre><code>0         Washington
1            Montana
2              Maine
3       North Dakota
4       South Dakota
5            Wyoming
6          Wisconsin
7              Idaho
8            Vermont
9          Minnesota
10            Oregon
11     New Hampshire
12              Iowa
13     Massachusetts
14          Nebraska
15          New York
16      Pennsylvania
17       Connecticut
18      Rhode Island
19        New Jersey
20           Indiana
21            Nevada
22              Utah
23        California
24              Ohio
25          Illinois
26          Delaware
27     West Virginia
28          Maryland
29          Colorado
30          Kentucky
31            Kansas
32          Virginia
33          Missouri
34           Arizona
35          Oklahoma
36    North Carolina
37         Tennessee
38             Texas
39        New Mexico
40           Alabama
41       Mississippi
42           Georgia
43    South Carolina
44          Arkansas
45         Louisiana
46           Florida
47          Michigan
Name: STATE_NAME, dtype: object
</code></pre><pre><code class="lang-python">f = ps.open(ps.examples.get_path(<span class="hljs-string">&quot;usjoin.csv&quot;</span>))
pci = np.array([f.by_col[str(y)] <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> range(<span class="hljs-number">1929</span>,<span class="hljs-number">2010</span>)])
pci.shape
</code></pre>
<pre><code>(81, 48)
</code></pre><pre><code class="lang-python">pci = pci.T
</code></pre>
<pre><code class="lang-python">pci.shape
</code></pre>
<pre><code>(48, 81)
</code></pre><pre><code class="lang-python">cnames = f.by_col(<span class="hljs-string">&apos;Name&apos;</span>)
</code></pre>
<pre><code class="lang-python">cnames[:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[&apos;Alabama&apos;,
 &apos;Arizona&apos;,
 &apos;Arkansas&apos;,
 &apos;California&apos;,
 &apos;Colorado&apos;,
 &apos;Connecticut&apos;,
 &apos;Delaware&apos;,
 &apos;Florida&apos;,
 &apos;Georgia&apos;,
 &apos;Idaho&apos;]
</code></pre><pre><code class="lang-python">ids = [ cnames.index(name) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> data.STATE_NAME]
</code></pre>
<pre><code class="lang-python">ids[:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[44, 23, 16, 31, 38, 47, 46, 9, 42, 20]
</code></pre><pre><code class="lang-python">pci = pci[ids]
RY = RY[ids]
</code></pre>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-keyword">import</span> geopandas <span class="hljs-keyword">as</span> gpd
shp_link = ps.examples.get_path(<span class="hljs-string">&apos;us48.shp&apos;</span>)
tx = gpd.read_file(shp_link)
pci29 = ps.Quantiles(pci[:,<span class="hljs-number">0</span>], k=<span class="hljs-number">5</span>)
f, ax = plt.subplots(<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>))
tx.assign(cl=pci29.yb+<span class="hljs-number">1</span>).plot(column=<span class="hljs-string">&apos;cl&apos;</span>, categorical=<span class="hljs-keyword">True</span>, \
        k=<span class="hljs-number">5</span>, cmap=<span class="hljs-string">&apos;Greens&apos;</span>, linewidth=<span class="hljs-number">0.1</span>, ax=ax, \
        edgecolor=<span class="hljs-string">&apos;grey&apos;</span>, legend=<span class="hljs-keyword">True</span>)
ax.set_axis_off()
plt.title(<span class="hljs-string">&apos;Per Capita Income 1929 Quintiles&apos;</span>)

plt.show()
</code></pre>
<p><img src="05_spatial_dynamics_files/05_spatial_dynamics_73_0.png" alt="png"></p>
<pre><code class="lang-python">pci2009 = ps.Quantiles(pci[:,<span class="hljs-number">-1</span>], k=<span class="hljs-number">5</span>)
f, ax = plt.subplots(<span class="hljs-number">1</span>, figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>))
tx.assign(cl=pci2009.yb+<span class="hljs-number">1</span>).plot(column=<span class="hljs-string">&apos;cl&apos;</span>, categorical=<span class="hljs-keyword">True</span>, \
        k=<span class="hljs-number">5</span>, cmap=<span class="hljs-string">&apos;Greens&apos;</span>, linewidth=<span class="hljs-number">0.1</span>, ax=ax, \
        edgecolor=<span class="hljs-string">&apos;grey&apos;</span>, legend=<span class="hljs-keyword">True</span>)
ax.set_axis_off()
plt.title(<span class="hljs-string">&apos;Per Capita Income 2009 Quintiles&apos;</span>)
plt.show()
</code></pre>
<p><img src="05_spatial_dynamics_files/05_spatial_dynamics_74_0.png" alt="png"></p>
<h2 id="convert-to-a-code-cell-to-generate-a-time-series-of-the-maps">convert to a code cell to generate a time series of the maps</h2>
<p>for y in range(2010-1929):
    pciy = ps.Quantiles(pci[:,y], k=5)
    f, ax = plt.subplots(1, figsize=(10, 5))
    tx.assign(cl=pciy.yb+1).plot(column=&apos;cl&apos;, categorical=True, \
            k=5, cmap=&apos;Greens&apos;, linewidth=0.1, ax=ax, \
            edgecolor=&apos;grey&apos;, legend=True)
    ax.set_axis_off()
    plt.title(&quot;Per Capita Income %d Quintiles&quot;%(1929+y))
    plt.show()</p>
<p>Put series into cross-sectional quintiles (i.e., quintiles for each year).</p>
<pre><code class="lang-python">q5 = np.array([ps.Quantiles(y).yb <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> pci.T]).transpose()
</code></pre>
<pre><code class="lang-python">q5.shape
</code></pre>
<pre><code>(48, 81)
</code></pre><pre><code class="lang-python">q5[:,<span class="hljs-number">0</span>]
</code></pre>
<pre><code>array([3, 2, 2, 0, 1, 3, 3, 1, 2, 2, 3, 3, 2, 4, 2, 4, 3, 4, 4, 4, 2, 4, 2,
       4, 3, 4, 4, 1, 3, 2, 0, 1, 1, 2, 2, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1,
       1, 4])
</code></pre><pre><code class="lang-python">pci.shape
</code></pre>
<pre><code>(48, 81)
</code></pre><pre><code class="lang-python">pci[<span class="hljs-number">0</span>]
</code></pre>
<pre><code>array([  741,   658,   534,   402,   376,   443,   490,   569,   599,
         582,   614,   658,   864,  1196,  1469,  1527,  1419,  1401,
        1504,  1624,  1595,  1721,  1874,  1973,  2066,  2077,  2116,
        2172,  2262,  2281,  2380,  2436,  2535,  2680,  2735,  2858,
        3078,  3385,  3566,  3850,  4097,  4205,  4381,  4731,  5312,
        5919,  6533,  7181,  7832,  8887,  9965, 10913, 11903, 12431,
       13124, 14021, 14738, 15522, 16300, 17270, 18670, 20026, 20901,
       21917, 22414, 23119, 23878, 25287, 26817, 28632, 30392, 31528,
       32053, 32206, 32934, 34984, 35738, 38477, 40782, 41588, 40619])
</code></pre><p>we are looping over the rows of y which is ordered $T \times n$ (rows are cross sections, row 0 is the cross-section for period 0.</p>
<pre><code class="lang-python">m5 = ps.Markov(q5)
</code></pre>
<pre><code class="lang-python">m5.classes
</code></pre>
<pre><code>array([0, 1, 2, 3, 4])
</code></pre><pre><code class="lang-python">m5.transitions
</code></pre>
<pre><code>array([[ 729.,   71.,    1.,    0.,    0.],
       [  72.,  567.,   80.,    3.,    0.],
       [   0.,   81.,  631.,   86.,    2.],
       [   0.,    3.,   86.,  573.,   56.],
       [   0.,    0.,    1.,   57.,  741.]])
</code></pre><pre><code class="lang-python">np.set_printoptions(<span class="hljs-number">3</span>, suppress=<span class="hljs-keyword">True</span>)
m5.p
</code></pre>
<pre><code>matrix([[ 0.91 ,  0.089,  0.001,  0.   ,  0.   ],
        [ 0.1  ,  0.785,  0.111,  0.004,  0.   ],
        [ 0.   ,  0.101,  0.789,  0.107,  0.003],
        [ 0.   ,  0.004,  0.12 ,  0.798,  0.078],
        [ 0.   ,  0.   ,  0.001,  0.071,  0.927]])
</code></pre><pre><code class="lang-python">m5.steady_state <span class="hljs-comment">#steady state distribution</span>
</code></pre>
<pre><code>matrix([[ 0.208],
        [ 0.187],
        [ 0.207],
        [ 0.188],
        [ 0.209]])
</code></pre><pre><code class="lang-python">fmpt = ps.ergodic.fmpt(m5.p) <span class="hljs-comment">#first mean passage time</span>
fmpt
</code></pre>
<pre><code>matrix([[   4.814,   11.503,   29.609,   53.386,  103.598],
        [  42.048,    5.34 ,   18.745,   42.5  ,   92.713],
        [  69.258,   27.211,    4.821,   25.272,   75.433],
        [  84.907,   42.859,   17.181,    5.313,   51.61 ],
        [  98.413,   56.365,   30.66 ,   14.212,    4.776]])
</code></pre><p>For a state with income in the first quintile, it takes on average 11.5 years for it to first enter the second quintile, 29.6 to get to the third quintile, 53.4 years to enter the fourth, and 103.6 years to reach the richest quintile.</p>
<p>But, this approach assumes the movement of a state in the income distribution is independent of the movement of its neighbors or the position of the neighbors in the distribution. Does spatial context matter?</p>
<h2 id="dynamics-of-spatial-dependence">Dynamics of Spatial Dependence</h2>
<p>Create a queen contiguity matrix that is row standardized</p>
<pre><code class="lang-python">w = ps.queen_from_shapefile(ps.examples.get_path(<span class="hljs-string">&apos;us48.shp&apos;</span>))
w.transform = <span class="hljs-string">&apos;R&apos;</span>
</code></pre>
<pre><code class="lang-python">mits = [ps.Moran(cs, w) <span class="hljs-keyword">for</span> cs <span class="hljs-keyword">in</span> RY.T]
</code></pre>
<pre><code class="lang-python">res = np.array([(m.I, m.EI, m.p_sim, m.z_sim) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> mits])
</code></pre>
<pre><code class="lang-python">plt.plot(years, res[:,<span class="hljs-number">0</span>], label=<span class="hljs-string">&apos;I&apos;</span>)
plt.plot(years, res[:,<span class="hljs-number">1</span>], label=<span class="hljs-string">&apos;E[I]&apos;</span>)
plt.title(<span class="hljs-string">&quot;Moran&apos;s I&quot;</span>)
plt.legend()
</code></pre>
<pre><code>&lt;matplotlib.legend.Legend at 0x7f912bf8d438&gt;
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_96_1.png" alt="png"></p>
<pre><code class="lang-python">plt.plot(years, res[:,<span class="hljs-number">-1</span>])
plt.ylim(<span class="hljs-number">0</span>,<span class="hljs-number">7.0</span>)
plt.title(<span class="hljs-string">&apos;z-values, I&apos;</span>)
</code></pre>
<pre><code>&lt;matplotlib.text.Text at 0x7f912beb4da0&gt;
</code></pre><p><img src="05_spatial_dynamics_files/05_spatial_dynamics_97_1.png" alt="png"></p>
<h2 id="spatial-markov">Spatial Markov</h2>
<pre><code class="lang-python">pci.shape
</code></pre>
<pre><code>(48, 81)
</code></pre><pre><code class="lang-python">rpci = pci / pci.mean(axis=<span class="hljs-number">0</span>)
</code></pre>
<pre><code class="lang-python">rpci[:,<span class="hljs-number">0</span>]
</code></pre>
<pre><code>array([ 1.204,  0.962,  0.977,  0.621,  0.692,  1.097,  1.094,  0.824,
        1.031,  0.974,  1.086,  1.115,  0.944,  1.473,  0.969,  1.873,
        1.255,  1.664,  1.421,  1.492,  0.987,  1.411,  0.896,  1.611,
        1.253,  1.541,  1.677,  0.748,  1.248,  1.031,  0.639,  0.865,
        0.705,  1.009,  0.975,  0.74 ,  0.54 ,  0.614,  0.779,  0.666,
        0.525,  0.465,  0.564,  0.441,  0.504,  0.673,  0.842,  1.284])
</code></pre><pre><code class="lang-python">rpci[:,<span class="hljs-number">0</span>].mean()
</code></pre>
<pre><code>0.99999999999999989
</code></pre><pre><code class="lang-python">sm = ps.Spatial_Markov(rpci, W, fixed=<span class="hljs-keyword">True</span>, k=<span class="hljs-number">5</span>)
</code></pre>
<pre><code class="lang-python">sm.p
</code></pre>
<pre><code>matrix([[ 0.915,  0.075,  0.009,  0.001,  0.   ],
        [ 0.066,  0.827,  0.105,  0.001,  0.001],
        [ 0.005,  0.103,  0.794,  0.095,  0.003],
        [ 0.   ,  0.009,  0.094,  0.849,  0.048],
        [ 0.   ,  0.   ,  0.   ,  0.062,  0.938]])
</code></pre><pre><code class="lang-python"><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> sm.P:
    print(p)
</code></pre>
<pre><code>[[ 0.963  0.03   0.006  0.     0.   ]
 [ 0.06   0.832  0.107  0.     0.   ]
 [ 0.     0.14   0.74   0.12   0.   ]
 [ 0.     0.036  0.321  0.571  0.071]
 [ 0.     0.     0.     0.167  0.833]]
[[ 0.798  0.168  0.034  0.     0.   ]
 [ 0.075  0.882  0.042  0.     0.   ]
 [ 0.005  0.07   0.866  0.059  0.   ]
 [ 0.     0.     0.064  0.902  0.034]
 [ 0.     0.     0.     0.194  0.806]]
[[ 0.847  0.153  0.     0.     0.   ]
 [ 0.081  0.789  0.129  0.     0.   ]
 [ 0.005  0.098  0.793  0.098  0.005]
 [ 0.     0.     0.094  0.871  0.035]
 [ 0.     0.     0.     0.102  0.898]]
[[ 0.885  0.098  0.     0.016  0.   ]
 [ 0.039  0.814  0.14   0.     0.008]
 [ 0.005  0.094  0.777  0.119  0.005]
 [ 0.     0.023  0.129  0.754  0.094]
 [ 0.     0.     0.     0.097  0.903]]
[[ 0.333  0.667  0.     0.     0.   ]
 [ 0.048  0.774  0.161  0.016  0.   ]
 [ 0.011  0.161  0.747  0.08   0.   ]
 [ 0.     0.01   0.062  0.896  0.031]
 [ 0.     0.     0.     0.024  0.976]]
</code></pre><pre><code class="lang-python">sm.S
</code></pre>
<pre><code>array([[ 0.435,  0.264,  0.204,  0.068,  0.029],
       [ 0.134,  0.34 ,  0.252,  0.233,  0.041],
       [ 0.121,  0.211,  0.264,  0.29 ,  0.114],
       [ 0.078,  0.197,  0.254,  0.225,  0.247],
       [ 0.018,  0.2  ,  0.19 ,  0.255,  0.337]])
</code></pre><pre><code class="lang-python"><span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> sm.F:
    print(f)
</code></pre>
<pre><code>[[   2.298   28.956   46.143   80.81   279.429]
 [  33.865    3.795   22.571   57.238  255.857]
 [  43.602    9.737    4.911   34.667  233.286]
 [  46.629   12.763    6.257   14.616  198.619]
 [  52.629   18.763   12.257    6.      34.103]]
[[   7.468    9.706   25.768   74.531  194.234]
 [  27.767    2.942   24.971   73.735  193.438]
 [  53.575   28.484    3.976   48.763  168.467]
 [  72.036   46.946   18.462    4.284  119.703]
 [  77.179   52.089   23.604    5.143   24.276]]
[[   8.248    6.533   18.388   40.709  112.767]
 [  47.35     4.731   11.854   34.175  106.234]
 [  69.423   24.767    3.795   22.321   94.38 ]
 [  83.723   39.067   14.3      3.447   76.367]
 [  93.523   48.867   24.1      9.8      8.793]]
[[  12.88    13.348   19.834   28.473   55.824]
 [  99.461    5.064   10.545   23.051   49.689]
 [ 117.768   23.037    3.944   15.084   43.579]
 [ 127.898   32.439   14.569    4.448   31.631]
 [ 138.248   42.789   24.919   10.35     4.056]]
[[  56.282    1.5     10.572   27.022  110.543]
 [  82.922    5.009    9.072   25.522  109.043]
 [  97.177   19.531    5.26    21.424  104.946]
 [ 127.141   48.741   33.296    3.918   83.522]
 [ 169.641   91.241   75.796   42.5      2.965]]
</code></pre><pre><code class="lang-python">sm.summary()
</code></pre>
<pre><code>--------------------------------------------------------------
                     Spatial Markov Test                      
--------------------------------------------------------------
Number of classes: 5
Number of transitions: 3840
Number of regimes: 5
Regime names: LAG0, LAG1, LAG2, LAG3, LAG4
--------------------------------------------------------------
   Test                   LR                Chi-2
  Stat.              170.659              200.624
    DOF                   60                   60
p-value                0.000                0.000
--------------------------------------------------------------
P(H0)           C0         C1         C2         C3         C4
     C0      0.915      0.075      0.009      0.001      0.000
     C1      0.066      0.827      0.105      0.001      0.001
     C2      0.005      0.103      0.794      0.095      0.003
     C3      0.000      0.009      0.094      0.849      0.048
     C4      0.000      0.000      0.000      0.062      0.938
--------------------------------------------------------------
P(LAG0)         C0         C1         C2         C3         C4
     C0      0.963      0.030      0.006      0.000      0.000
     C1      0.060      0.832      0.107      0.000      0.000
     C2      0.000      0.140      0.740      0.120      0.000
     C3      0.000      0.036      0.321      0.571      0.071
     C4      0.000      0.000      0.000      0.167      0.833
--------------------------------------------------------------
P(LAG1)         C0         C1         C2         C3         C4
     C0      0.798      0.168      0.034      0.000      0.000
     C1      0.075      0.882      0.042      0.000      0.000
     C2      0.005      0.070      0.866      0.059      0.000
     C3      0.000      0.000      0.064      0.902      0.034
     C4      0.000      0.000      0.000      0.194      0.806
--------------------------------------------------------------
P(LAG2)         C0         C1         C2         C3         C4
     C0      0.847      0.153      0.000      0.000      0.000
     C1      0.081      0.789      0.129      0.000      0.000
     C2      0.005      0.098      0.793      0.098      0.005
     C3      0.000      0.000      0.094      0.871      0.035
     C4      0.000      0.000      0.000      0.102      0.898
--------------------------------------------------------------
P(LAG3)         C0         C1         C2         C3         C4
     C0      0.885      0.098      0.000      0.016      0.000
     C1      0.039      0.814      0.140      0.000      0.008
     C2      0.005      0.094      0.777      0.119      0.005
     C3      0.000      0.023      0.129      0.754      0.094
     C4      0.000      0.000      0.000      0.097      0.903
--------------------------------------------------------------
P(LAG4)         C0         C1         C2         C3         C4
     C0      0.333      0.667      0.000      0.000      0.000
     C1      0.048      0.774      0.161      0.016      0.000
     C2      0.011      0.161      0.747      0.080      0.000
     C3      0.000      0.010      0.062      0.896      0.031
     C4      0.000      0.000      0.000      0.024      0.976
--------------------------------------------------------------
</code></pre>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="04_esda.html" class="navigation navigation-prev " aria-label="Previous page: ESDA with PySAL">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../content/part2/" class="navigation navigation-next " aria-label="Next page: Part II">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Space-time analysis","level":"1.7.5","depth":2,"next":{"title":"Part II","level":"1.8","depth":1,"path":"content/part2/README.md","ref":"content/part2/README.md","articles":[{"title":"Points","level":"1.8.1","depth":2,"path":"ipynb_md/06_points.md","ref":"ipynb_md/06_points.md","articles":[]},{"title":"Spatial clustering","level":"1.8.2","depth":2,"path":"ipynb_md/07_spatial_clustering.md","ref":"ipynb_md/07_spatial_clustering.md","articles":[]},{"title":"Spatial Regression","level":"1.8.3","depth":2,"path":"ipynb_md/08_spatial_regression.md","ref":"ipynb_md/08_spatial_regression.md","articles":[]}]},"previous":{"title":"ESDA with PySAL","level":"1.7.4","depth":2,"path":"ipynb_md/04_esda.md","ref":"ipynb_md/04_esda.md","articles":[]},"dir":"ltr"},"config":{"plugins":["katex-dev"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"katex-dev":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Serif","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Geographic Data Science with PySAL and the pydata stack","gitbook":">=3.0.0","description":"Booklet with material for the workshop at Scipy'16"},"file":{"path":"ipynb_md/05_spatial_dynamics.md","mtime":"2021-03-07T14:03:25.583Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-03-07T15:04:32.023Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

