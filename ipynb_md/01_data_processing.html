
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Spatial data processing with PySAL Â· Geographic Data Science with PySAL and the pydata stack</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex-dev/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="02_geovisualization.html" />
    
    
    <link rel="prev" href="../content/part1/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../distribution.html">
            
                <a href="../distribution.html">
            
                    
                    Distribution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../content/about.html">
            
                <a href="../content/about.html">
            
                    
                    About the authors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../content/infrastructure/">
            
                <a href="../content/infrastructure/">
            
                    
                    Install guide
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../content/outline.html">
            
                <a href="../content/outline.html">
            
                    
                    Outline
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../content/data/">
            
                <a href="../content/data/">
            
                    
                    Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../content/part1/">
            
                <a href="../content/part1/">
            
                    
                    Part I
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.7.1" data-path="01_data_processing.html">
            
                <a href="01_data_processing.html">
            
                    
                    Spatial data processing with PySAL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="02_geovisualization.html">
            
                <a href="02_geovisualization.html">
            
                    
                    Geovisualization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="03_spatial_weights.html">
            
                <a href="03_spatial_weights.html">
            
                    
                    Spatial weights in PySAL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="04_esda.html">
            
                <a href="04_esda.html">
            
                    
                    ESDA with PySAL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="05_spatial_dynamics.html">
            
                <a href="05_spatial_dynamics.html">
            
                    
                    Space-time analysis
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../content/part2/">
            
                <a href="../content/part2/">
            
                    
                    Part II
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="06_points.html">
            
                <a href="06_points.html">
            
                    
                    Points
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="07_spatial_clustering.html">
            
                <a href="07_spatial_clustering.html">
            
                    
                    Spatial clustering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="08_spatial_regression.html">
            
                <a href="08_spatial_regression.html">
            
                    
                    Spatial Regression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../content/infrastructure/workflow.html">
            
                <a href="../content/infrastructure/workflow.html">
            
                    
                    Development notes
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Spatial data processing with PySAL</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="spatial-data-processing-with-pysal--pandas">Spatial Data Processing with PySAL &amp; Pandas</h1>
<blockquote>
<p><a href="../content/part1/01_data_processing.ipynb"><code>IPYNB</code></a></p>
</blockquote>
<pre><code class="lang-python"><span class="hljs-comment">#by convention, we use these shorter two-letter names</span>
<span class="hljs-keyword">import</span> pysal <span class="hljs-keyword">as</span> ps
<span class="hljs-keyword">import</span> libpysal <span class="hljs-keyword">as</span> lps
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
</code></pre>
<p>PySAL has two simple ways to read in data. But, first, you need to get the path from where your notebook is running on your computer to the place the data is. For example, to find where the notebook is running:</p>
<pre><code class="lang-python">!pwd <span class="hljs-comment"># on windows !cd</span>
</code></pre>
<pre><code>/Users/admin/code/gds/content/part1
</code></pre><p>PySAL has a command that it uses to get the paths of its example datasets. Let&apos;s work with a commonly-used dataset first. </p>
<pre><code class="lang-python">lps.examples.available()
</code></pre>
<pre><code>[&apos;10740&apos;,
 &apos;arcgis&apos;,
 &apos;baltim&apos;,
 &apos;book&apos;,
 &apos;burkitt&apos;,
 &apos;calemp&apos;,
 &apos;chicago&apos;,
 &apos;columbus&apos;,
 &apos;desmith&apos;,
 &apos;geodanet&apos;,
 &apos;juvenile&apos;,
 &apos;Line&apos;,
 &apos;mexico&apos;,
 &apos;nat&apos;,
 &apos;networks&apos;,
 &apos;newHaven&apos;,
 &apos;Point&apos;,
 &apos;Polygon&apos;,
 &apos;sacramento2&apos;,
 &apos;sids2&apos;,
 &apos;snow_maps&apos;,
 &apos;south&apos;,
 &apos;stl&apos;,
 &apos;street_net_pts&apos;,
 &apos;taz&apos;,
 &apos;us_income&apos;,
 &apos;virginia&apos;,
 &apos;wmat&apos;]
</code></pre><pre><code class="lang-python">lps.examples.explain(<span class="hljs-string">&apos;us_income&apos;</span>)
</code></pre>
<pre><code>{&apos;description&apos;: &apos;Per-capita income for the lower 47 US states 1929-2010&apos;,
 &apos;explanation&apos;: [&apos; * us48.shp: shapefile &apos;,
  &apos; * us48.dbf: dbf for shapefile&apos;,
  &apos; * us48.shx: index for shapefile&apos;,
  &apos; * usjoin.csv: attribute data (comma delimited file)&apos;],
 &apos;name&apos;: &apos;us_income&apos;}
</code></pre><pre><code class="lang-python">csv_path = lps.examples.get_path(<span class="hljs-string">&apos;usjoin.csv&apos;</span>)
</code></pre>
<pre><code class="lang-python">f = lps.io.open(csv_path)
f.header[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[&apos;Name&apos;,
 &apos;STATE_FIPS&apos;,
 &apos;1929&apos;,
 &apos;1930&apos;,
 &apos;1931&apos;,
 &apos;1932&apos;,
 &apos;1933&apos;,
 &apos;1934&apos;,
 &apos;1935&apos;,
 &apos;1936&apos;]
</code></pre><pre><code class="lang-python">y2009 = f.by_col(<span class="hljs-string">&apos;2009&apos;</span>)
</code></pre>
<pre><code class="lang-python">y2009[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[32274, 32077, 31493, 40902, 40093, 52736, 40135, 36565, 33086, 30987]
</code></pre><h3 id="working-with-shapefiles">Working with shapefiles</h3>
<p>We can also work with local files outside the built-in examples.</p>
<p>To read in a shapefile, we will need the path to the file.</p>
<pre><code class="lang-python">shp_path = <span class="hljs-string">&apos;data/texas.shp&apos;</span>
print(shp_path)
</code></pre>
<pre><code>data/texas.shp
</code></pre><p>Then, we open the file using the <code>lps.io.open</code> command:</p>
<pre><code class="lang-python">f = lps.io.open(shp_path)
</code></pre>
<p><code>f</code> is what we call a &quot;file handle.&quot; That means that it only <em>points</em> to the data and provides ways to work with it. By itself, it does not read the whole dataset into memory. To see basic information about the file, we can use a few different methods. </p>
<p>For instance, the header of the file, which contains most of the metadata about the file:</p>
<pre><code class="lang-python">f.header
</code></pre>
<pre><code>{&apos;BBOX Mmax&apos;: 0.0,
 &apos;BBOX Mmin&apos;: 0.0,
 &apos;BBOX Xmax&apos;: -93.50721740722656,
 &apos;BBOX Xmin&apos;: -106.6495132446289,
 &apos;BBOX Ymax&apos;: 36.49387741088867,
 &apos;BBOX Ymin&apos;: 25.845197677612305,
 &apos;BBOX Zmax&apos;: 0.0,
 &apos;BBOX Zmin&apos;: 0.0,
 &apos;File Code&apos;: 9994,
 &apos;File Length&apos;: 49902,
 &apos;Shape Type&apos;: 5,
 &apos;Unused0&apos;: 0,
 &apos;Unused1&apos;: 0,
 &apos;Unused2&apos;: 0,
 &apos;Unused3&apos;: 0,
 &apos;Unused4&apos;: 0,
 &apos;Version&apos;: 1000}
</code></pre><p>To actually read in the shapes from memory, you can use the following commands:</p>
<pre><code class="lang-python">f.by_row(<span class="hljs-number">14</span>) <span class="hljs-comment">#gets the 14th shape from the file</span>
</code></pre>
<pre><code>&lt;pysal.cg.shapes.Polygon at 0x10d8baa20&gt;
</code></pre><pre><code class="lang-python">all_polygons = f.read() <span class="hljs-comment">#reads in all polygons from memory</span>
</code></pre>
<pre><code class="lang-python">len(all_polygons)
</code></pre>
<pre><code>254
</code></pre><p>So, all 254 polygons have been read in from file. These are stored in PySAL shape objects, which can be used by PySAL and can be converted to other Python shape objects.</p>
<p>They typically have a few methods. So, since we&apos;ve read in polygonal data, we can get some properties about the polygons. Let&apos;s just have a look at the first polygon:</p>
<pre><code class="lang-python">all_polygons[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>]
</code></pre>
<pre><code>[&lt;pysal.cg.shapes.Polygon at 0x10d8baba8&gt;,
 &lt;pysal.cg.shapes.Polygon at 0x10d8ba908&gt;,
 &lt;pysal.cg.shapes.Polygon at 0x10d8ba860&gt;,
 &lt;pysal.cg.shapes.Polygon at 0x10d8ba8d0&gt;,
 &lt;pysal.cg.shapes.Polygon at 0x10d8baa90&gt;]
</code></pre><pre><code class="lang-python">all_polygons[<span class="hljs-number">0</span>].centroid <span class="hljs-comment">#the centroid of the first polygon</span>
</code></pre>
<pre><code>(-100.27156110567945, 36.27508640938005)
</code></pre><pre><code class="lang-python">all_polygons[<span class="hljs-number">0</span>].area
</code></pre>
<pre><code>0.23682222998468205
</code></pre><pre><code class="lang-python">all_polygons[<span class="hljs-number">0</span>].perimeter
</code></pre>
<pre><code>1.9582821721538344
</code></pre><p>While in the Jupyter Notebook, you can examine what properties an object has by using the tab key.</p>
<pre><code class="lang-python">polygon = all_polygons[<span class="hljs-number">0</span>]
</code></pre>
<pre><code class="lang-python">polygon. <span class="hljs-comment">#press tab when the cursor is right after the dot</span>
</code></pre>
<pre><code>  File &quot;&lt;ipython-input-20-aa03438a2fa8&gt;&quot;, line 1
    polygon. #press tab when the cursor is right after the dot
                                                              ^
SyntaxError: invalid syntax
</code></pre><h3 id="working-with-data-tables">Working with Data Tables</h3>
<pre><code class="lang-python">dbf_path = <span class="hljs-string">&quot;data/texas.dbf&quot;</span>
print(dbf_path)
</code></pre>
<pre><code>data/texas.dbf
</code></pre><p>When you&apos;re working with tables of data, like a <code>csv</code> or <code>dbf</code>, you can extract your data in the following way. Let&apos;s open the dbf file we got the path for above.</p>
<pre><code class="lang-python">f = lps.io.open(dbf_path)
</code></pre>
<p>Just like with the shapefile, we can examine the header of the dbf file.</p>
<pre><code class="lang-python">f.header
</code></pre>
<pre><code>[&apos;NAME&apos;,
 &apos;STATE_NAME&apos;,
 &apos;STATE_FIPS&apos;,
 &apos;CNTY_FIPS&apos;,
 &apos;FIPS&apos;,
 &apos;STFIPS&apos;,
 &apos;COFIPS&apos;,
 &apos;FIPSNO&apos;,
 &apos;SOUTH&apos;,
 &apos;HR60&apos;,
 &apos;HR70&apos;,
 &apos;HR80&apos;,
 &apos;HR90&apos;,
 &apos;HC60&apos;,
 &apos;HC70&apos;,
 &apos;HC80&apos;,
 &apos;HC90&apos;,
 &apos;PO60&apos;,
 &apos;PO70&apos;,
 &apos;PO80&apos;,
 &apos;PO90&apos;,
 &apos;RD60&apos;,
 &apos;RD70&apos;,
 &apos;RD80&apos;,
 &apos;RD90&apos;,
 &apos;PS60&apos;,
 &apos;PS70&apos;,
 &apos;PS80&apos;,
 &apos;PS90&apos;,
 &apos;UE60&apos;,
 &apos;UE70&apos;,
 &apos;UE80&apos;,
 &apos;UE90&apos;,
 &apos;DV60&apos;,
 &apos;DV70&apos;,
 &apos;DV80&apos;,
 &apos;DV90&apos;,
 &apos;MA60&apos;,
 &apos;MA70&apos;,
 &apos;MA80&apos;,
 &apos;MA90&apos;,
 &apos;POL60&apos;,
 &apos;POL70&apos;,
 &apos;POL80&apos;,
 &apos;POL90&apos;,
 &apos;DNL60&apos;,
 &apos;DNL70&apos;,
 &apos;DNL80&apos;,
 &apos;DNL90&apos;,
 &apos;MFIL59&apos;,
 &apos;MFIL69&apos;,
 &apos;MFIL79&apos;,
 &apos;MFIL89&apos;,
 &apos;FP59&apos;,
 &apos;FP69&apos;,
 &apos;FP79&apos;,
 &apos;FP89&apos;,
 &apos;BLK60&apos;,
 &apos;BLK70&apos;,
 &apos;BLK80&apos;,
 &apos;BLK90&apos;,
 &apos;GI59&apos;,
 &apos;GI69&apos;,
 &apos;GI79&apos;,
 &apos;GI89&apos;,
 &apos;FH60&apos;,
 &apos;FH70&apos;,
 &apos;FH80&apos;,
 &apos;FH90&apos;]
</code></pre><p>So, the header is a list containing the names of all of the fields we can read.
If we just wanted to grab the data of interest, <code>HR90</code>, we can use either <code>by_col</code> or <code>by_col_array</code>, depending on the format we want the resulting data in:</p>
<pre><code class="lang-python">HR90 = f.by_col(<span class="hljs-string">&apos;HR90&apos;</span>)
print(type(HR90).__name__, HR90[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>])
HR90 = f.by_col_array(<span class="hljs-string">&apos;HR90&apos;</span>)
print(type(HR90).__name__, HR90[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>])
</code></pre>
<pre><code>list [0.0, 0.0, 18.31166453, 0.0, 3.6517674554]
ndarray [[  0.        ]
 [  0.        ]
 [ 18.31166453]
 [  0.        ]
 [  3.65176746]]
</code></pre><p>As you can see, the <code>by_col</code> function returns a list of data, with no shape. It can only return one column at a time:</p>
<pre><code class="lang-python">HRs = f.by_col(<span class="hljs-string">&apos;HR90&apos;</span>, <span class="hljs-string">&apos;HR80&apos;</span>)
</code></pre>
<pre><code>---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

&lt;ipython-input-25-1fef6a3c3a50&gt; in &lt;module&gt;()
----&gt; 1 HRs = f.by_col(&apos;HR90&apos;, &apos;HR80&apos;)


TypeError: __call__() takes 2 positional arguments but 3 were given
</code></pre><p>This error message is called a &quot;traceback,&quot; as you see in the top right, and it usually provides feedback on why the previous command did not execute correctly. Here, you see that one-too-many arguments was provided to <code>__call__</code>, which tells us we cannot pass as many arguments as we did to <code>by_col</code>.</p>
<p>If you want to read in many columns at once and store them to an array, use <code>by_col_array</code>:</p>
<pre><code class="lang-python">HRs = f.by_col_array(<span class="hljs-string">&apos;HR90&apos;</span>, <span class="hljs-string">&apos;HR80&apos;</span>)
</code></pre>
<pre><code class="lang-python">HRs[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>array([[  0.        ,   0.        ],
       [  0.        ,  10.50199538],
       [ 18.31166453,   5.10386362],
       [  0.        ,   0.        ],
       [  3.65176746,  10.4297038 ],
       [  0.        ,   0.        ],
       [  0.        ,  18.85369532],
       [  2.59514448,   6.33617194],
       [  0.        ,   0.        ],
       [  5.59753708,   6.0331825 ]])
</code></pre><p>It is best to use <code>by_col_array</code> on data of a single type. That is, if you read in a lot of columns, some of them numbers and some of them strings, all columns will get converted to the same datatype:</p>
<pre><code class="lang-python">allcolumns = f.by_col_array([<span class="hljs-string">&apos;NAME&apos;</span>, <span class="hljs-string">&apos;STATE_NAME&apos;</span>, <span class="hljs-string">&apos;HR90&apos;</span>, <span class="hljs-string">&apos;HR80&apos;</span>])
</code></pre>
<pre><code class="lang-python">allcolumns
</code></pre>
<pre><code>array([[&apos;Lipscomb&apos;, &apos;Texas&apos;, &apos;0.0&apos;, &apos;0.0&apos;],
       [&apos;Sherman&apos;, &apos;Texas&apos;, &apos;0.0&apos;, &apos;10.501995379&apos;],
       [&apos;Dallam&apos;, &apos;Texas&apos;, &apos;18.31166453&apos;, &apos;5.1038636248&apos;],
       ..., 
       [&apos;Hidalgo&apos;, &apos;Texas&apos;, &apos;7.3003167816&apos;, &apos;8.2383277607&apos;],
       [&apos;Willacy&apos;, &apos;Texas&apos;, &apos;5.6481219994&apos;, &apos;7.6212251119&apos;],
       [&apos;Cameron&apos;, &apos;Texas&apos;, &apos;12.302014455&apos;, &apos;11.761321464&apos;]], 
      dtype=&apos;&lt;U13&apos;)
</code></pre><p>Note that the numerical columns, <code>HR90</code> &amp; <code>HR80</code> are now considered strings, since they show up with the single tickmarks around them, like <code>&apos;0.0&apos;</code>.</p>
<p>These methods work similarly for <code>.csv</code> files as well.</p>
<h3 id="using-pandas-with-pysal">Using Pandas with PySAL</h3>
<p>A new functionality added to PySAL recently allows you to work with shapefile/dbf pairs using Pandas. This <em>optional</em> extension is only turned on if you have Pandas installed. The extension is the <code>lps.io</code> module:</p>
<pre><code class="lang-python">lps.io
</code></pre>
<pre><code>&lt;module &apos;pysal.contrib.pdutilities&apos; from &apos;/Users/dani/anaconda/envs/gds-scipy16/lib/python3.5/site-packages/pysal/contrib/pdutilities/__init__.py&apos;&gt;
</code></pre><p>To use it, you can read in shapefile/dbf pairs using the <code>ps.pdio.read_files</code> command. </p>
<pre><code class="lang-python">shp_path = lps.examples.get_path(<span class="hljs-string">&apos;virginia.shp&apos;</span>)
data_table = lps.io.shp_file(shp_path)
</code></pre>
<p>This reads in <em>the entire database table</em> and adds a column to the end, called <code>geometry</code>, that stores the geometries read in from the shapefile. </p>
<p>Now, you can work with it like a standard pandas dataframe.</p>
<pre><code class="lang-python">data_table.header
</code></pre>
<p>{&apos;File Code&apos;: 9994,
&apos;Unused0&apos;: 0,
&apos;Unused1&apos;: 0,
&apos;Unused2&apos;: 0,
&apos;Unused3&apos;: 0,
&apos;Unused4&apos;: 0,
&apos;File Length&apos;: 35708,
&apos;Version&apos;: 1000,
&apos;Shape Type&apos;: 5,
&apos;BBOX Xmin&apos;: -83.67526245117188,
&apos;BBOX Ymin&apos;: 36.541481018066406,
&apos;BBOX Xmax&apos;: -75.24258422851562,
&apos;BBOX Ymax&apos;: 39.45690155029297,
&apos;BBOX Zmin&apos;: 0.0,
&apos;BBOX Zmax&apos;: 0.0,
&apos;BBOX Mmin&apos;: 0.0,
&apos;BBOX Mmax&apos;: 0.0}</p>
<p>The <code>read_files</code> function only works on shapefile/dbf pairs. If you need to read in data using CSVs, use pandas directly:</p>
<pre><code class="lang-python">usjoin = pd.read_csv(csv_path)
<span class="hljs-comment">#usjoin = ps.pdio.read_files(csv_path) #will not work, not a shp/dbf pair</span>
</code></pre>
<pre><code class="lang-python">usjoin.head()
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Name</th>
      <th>STATE_FIPS</th>
      <th>1929</th>
      <th>1930</th>
      <th>1931</th>
      <th>1932</th>
      <th>1933</th>
      <th>1934</th>
      <th>1935</th>
      <th>1936</th>
      <th>...</th>
      <th>2000</th>
      <th>2001</th>
      <th>2002</th>
      <th>2003</th>
      <th>2004</th>
      <th>2005</th>
      <th>2006</th>
      <th>2007</th>
      <th>2008</th>
      <th>2009</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alabama</td>
      <td>1</td>
      <td>323</td>
      <td>267</td>
      <td>224</td>
      <td>162</td>
      <td>166</td>
      <td>211</td>
      <td>217</td>
      <td>251</td>
      <td>...</td>
      <td>23471</td>
      <td>24467</td>
      <td>25161</td>
      <td>26065</td>
      <td>27665</td>
      <td>29097</td>
      <td>30634</td>
      <td>31988</td>
      <td>32819</td>
      <td>32274</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Arizona</td>
      <td>4</td>
      <td>600</td>
      <td>520</td>
      <td>429</td>
      <td>321</td>
      <td>308</td>
      <td>362</td>
      <td>416</td>
      <td>462</td>
      <td>...</td>
      <td>25578</td>
      <td>26232</td>
      <td>26469</td>
      <td>27106</td>
      <td>28753</td>
      <td>30671</td>
      <td>32552</td>
      <td>33470</td>
      <td>33445</td>
      <td>32077</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Arkansas</td>
      <td>5</td>
      <td>310</td>
      <td>228</td>
      <td>215</td>
      <td>157</td>
      <td>157</td>
      <td>187</td>
      <td>207</td>
      <td>247</td>
      <td>...</td>
      <td>22257</td>
      <td>23532</td>
      <td>23929</td>
      <td>25074</td>
      <td>26465</td>
      <td>27512</td>
      <td>29041</td>
      <td>31070</td>
      <td>31800</td>
      <td>31493</td>
    </tr>
    <tr>
      <th>3</th>
      <td>California</td>
      <td>6</td>
      <td>991</td>
      <td>887</td>
      <td>749</td>
      <td>580</td>
      <td>546</td>
      <td>603</td>
      <td>660</td>
      <td>771</td>
      <td>...</td>
      <td>32275</td>
      <td>32750</td>
      <td>32900</td>
      <td>33801</td>
      <td>35663</td>
      <td>37463</td>
      <td>40169</td>
      <td>41943</td>
      <td>42377</td>
      <td>40902</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Colorado</td>
      <td>8</td>
      <td>634</td>
      <td>578</td>
      <td>471</td>
      <td>354</td>
      <td>353</td>
      <td>368</td>
      <td>444</td>
      <td>542</td>
      <td>...</td>
      <td>32949</td>
      <td>34228</td>
      <td>33963</td>
      <td>34092</td>
      <td>35543</td>
      <td>37388</td>
      <td>39662</td>
      <td>41165</td>
      <td>41719</td>
      <td>40093</td>
    </tr>
  </tbody>
</table>
<p>5 rows &#xD7; 83 columns</p>
</div>



<p>The nice thing about working with pandas dataframes is that they have very powerful baked-in support for relational-style queries. By this, I mean that it is very easy to find things like:</p>
<p>The number of counties in each state:</p>
<pre><code class="lang-python">data_table.groupby(<span class="hljs-string">&quot;STATE_NAME&quot;</span>).size()
</code></pre>
<pre><code>STATE_NAME
Alabama                  67
Arizona                  14
Arkansas                 75
California               58
Colorado                 63
Connecticut               8
Delaware                  3
District of Columbia      1
Florida                  67
Georgia                 159
Idaho                    44
Illinois                102
Indiana                  92
Iowa                     99
Kansas                  105
Kentucky                120
Louisiana                64
Maine                    16
Maryland                 24
Massachusetts            12
Michigan                 83
Minnesota                87
Mississippi              82
Missouri                115
Montana                  55
Nebraska                 93
Nevada                   17
New Hampshire            10
New Jersey               21
New Mexico               32
New York                 58
North Carolina          100
North Dakota             53
Ohio                     88
Oklahoma                 77
Oregon                   36
Pennsylvania             67
Rhode Island              5
South Carolina           46
South Dakota             66
Tennessee                95
Texas                   254
Utah                     29
Vermont                  14
Virginia                123
Washington               38
West Virginia            55
Wisconsin                70
Wyoming                  23
dtype: int64
</code></pre><p>Or, to get the rows of the table that are in Arizona, we can use the <code>query</code> function of the dataframe:</p>
<pre><code class="lang-python">data_table.query(<span class="hljs-string">&apos;STATE_NAME == &quot;Arizona&quot;&apos;</span>)
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1707</th>
      <td>Navajo</td>
      <td>Arizona</td>
      <td>04</td>
      <td>017</td>
      <td>04017</td>
      <td>4</td>
      <td>17</td>
      <td>4017</td>
      <td>0</td>
      <td>5.263989</td>
      <td>...</td>
      <td>0.905251</td>
      <td>0.366863</td>
      <td>0.414135</td>
      <td>0.401999</td>
      <td>0.445299</td>
      <td>13.146998</td>
      <td>12.1</td>
      <td>13.762783</td>
      <td>18.033782</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e280080&gt;</td>
    </tr>
    <tr>
      <th>1708</th>
      <td>Coconino</td>
      <td>Arizona</td>
      <td>04</td>
      <td>005</td>
      <td>04005</td>
      <td>4</td>
      <td>5</td>
      <td>4005</td>
      <td>0</td>
      <td>3.185449</td>
      <td>...</td>
      <td>1.469081</td>
      <td>0.301222</td>
      <td>0.377785</td>
      <td>0.381655</td>
      <td>0.403188</td>
      <td>9.475171</td>
      <td>8.5</td>
      <td>11.181563</td>
      <td>15.267643</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2800f0&gt;</td>
    </tr>
    <tr>
      <th>1722</th>
      <td>Mohave</td>
      <td>Arizona</td>
      <td>04</td>
      <td>015</td>
      <td>04015</td>
      <td>4</td>
      <td>15</td>
      <td>4015</td>
      <td>0</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.324075</td>
      <td>0.279339</td>
      <td>0.347150</td>
      <td>0.375790</td>
      <td>0.374383</td>
      <td>11.508554</td>
      <td>4.8</td>
      <td>7.018268</td>
      <td>9.214294</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e280710&gt;</td>
    </tr>
    <tr>
      <th>1726</th>
      <td>Apache</td>
      <td>Arizona</td>
      <td>04</td>
      <td>001</td>
      <td>04001</td>
      <td>4</td>
      <td>1</td>
      <td>4001</td>
      <td>0</td>
      <td>10.951223</td>
      <td>...</td>
      <td>0.162361</td>
      <td>0.395913</td>
      <td>0.450552</td>
      <td>0.431013</td>
      <td>0.489132</td>
      <td>15.014738</td>
      <td>14.6</td>
      <td>18.727548</td>
      <td>22.933635</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2808d0&gt;</td>
    </tr>
    <tr>
      <th>2002</th>
      <td>Yavapai</td>
      <td>Arizona</td>
      <td>04</td>
      <td>025</td>
      <td>04025</td>
      <td>4</td>
      <td>25</td>
      <td>4025</td>
      <td>0</td>
      <td>3.458771</td>
      <td>...</td>
      <td>0.298011</td>
      <td>0.289509</td>
      <td>0.378195</td>
      <td>0.376313</td>
      <td>0.384089</td>
      <td>9.930032</td>
      <td>8.6</td>
      <td>7.516372</td>
      <td>9.483521</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e394518&gt;</td>
    </tr>
    <tr>
      <th>2182</th>
      <td>Gila</td>
      <td>Arizona</td>
      <td>04</td>
      <td>007</td>
      <td>04007</td>
      <td>4</td>
      <td>7</td>
      <td>4007</td>
      <td>0</td>
      <td>6.473749</td>
      <td>...</td>
      <td>0.246171</td>
      <td>0.265294</td>
      <td>0.337519</td>
      <td>0.353848</td>
      <td>0.386976</td>
      <td>10.470261</td>
      <td>8.1</td>
      <td>9.934237</td>
      <td>11.706102</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4500b8&gt;</td>
    </tr>
    <tr>
      <th>2262</th>
      <td>Maricopa</td>
      <td>Arizona</td>
      <td>04</td>
      <td>013</td>
      <td>04013</td>
      <td>4</td>
      <td>13</td>
      <td>4013</td>
      <td>0</td>
      <td>6.179259</td>
      <td>...</td>
      <td>3.499221</td>
      <td>0.277828</td>
      <td>0.352374</td>
      <td>0.366015</td>
      <td>0.372756</td>
      <td>10.642382</td>
      <td>9.8</td>
      <td>11.857260</td>
      <td>14.404902</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e49d438&gt;</td>
    </tr>
    <tr>
      <th>2311</th>
      <td>Greenlee</td>
      <td>Arizona</td>
      <td>04</td>
      <td>011</td>
      <td>04011</td>
      <td>4</td>
      <td>11</td>
      <td>4011</td>
      <td>0</td>
      <td>2.896284</td>
      <td>...</td>
      <td>0.349650</td>
      <td>0.177691</td>
      <td>0.257158</td>
      <td>0.283518</td>
      <td>0.337256</td>
      <td>9.806115</td>
      <td>6.7</td>
      <td>5.295110</td>
      <td>10.453284</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4c1a58&gt;</td>
    </tr>
    <tr>
      <th>2326</th>
      <td>Graham</td>
      <td>Arizona</td>
      <td>04</td>
      <td>009</td>
      <td>04009</td>
      <td>4</td>
      <td>9</td>
      <td>4009</td>
      <td>0</td>
      <td>4.746648</td>
      <td>...</td>
      <td>1.890487</td>
      <td>0.310256</td>
      <td>0.362926</td>
      <td>0.383554</td>
      <td>0.408379</td>
      <td>11.979335</td>
      <td>10.1</td>
      <td>11.961367</td>
      <td>16.129032</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ea128&gt;</td>
    </tr>
    <tr>
      <th>2353</th>
      <td>Pinal</td>
      <td>Arizona</td>
      <td>04</td>
      <td>021</td>
      <td>04021</td>
      <td>4</td>
      <td>21</td>
      <td>4021</td>
      <td>0</td>
      <td>13.828390</td>
      <td>...</td>
      <td>3.134586</td>
      <td>0.304294</td>
      <td>0.369974</td>
      <td>0.361193</td>
      <td>0.400130</td>
      <td>10.822965</td>
      <td>8.8</td>
      <td>10.341699</td>
      <td>15.304144</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ead68&gt;</td>
    </tr>
    <tr>
      <th>2499</th>
      <td>Pima</td>
      <td>Arizona</td>
      <td>04</td>
      <td>019</td>
      <td>04019</td>
      <td>4</td>
      <td>19</td>
      <td>4019</td>
      <td>0</td>
      <td>5.520841</td>
      <td>...</td>
      <td>3.118252</td>
      <td>0.268266</td>
      <td>0.367218</td>
      <td>0.375039</td>
      <td>0.392144</td>
      <td>11.381626</td>
      <td>10.2</td>
      <td>12.689768</td>
      <td>16.163178</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e575e80&gt;</td>
    </tr>
    <tr>
      <th>2514</th>
      <td>Cochise</td>
      <td>Arizona</td>
      <td>04</td>
      <td>003</td>
      <td>04003</td>
      <td>4</td>
      <td>3</td>
      <td>4003</td>
      <td>0</td>
      <td>4.845049</td>
      <td>...</td>
      <td>5.201590</td>
      <td>0.261208</td>
      <td>0.359500</td>
      <td>0.359701</td>
      <td>0.399208</td>
      <td>10.197573</td>
      <td>8.7</td>
      <td>9.912732</td>
      <td>13.733872</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e59b550&gt;</td>
    </tr>
    <tr>
      <th>2615</th>
      <td>Santa Cruz</td>
      <td>Arizona</td>
      <td>04</td>
      <td>023</td>
      <td>04023</td>
      <td>4</td>
      <td>23</td>
      <td>4023</td>
      <td>0</td>
      <td>9.252406</td>
      <td>...</td>
      <td>0.326863</td>
      <td>0.327130</td>
      <td>0.396807</td>
      <td>0.393240</td>
      <td>0.413795</td>
      <td>19.007213</td>
      <td>14.7</td>
      <td>15.690913</td>
      <td>18.272244</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e60a2e8&gt;</td>
    </tr>
    <tr>
      <th>3080</th>
      <td>La Paz</td>
      <td>Arizona</td>
      <td>04</td>
      <td>012</td>
      <td>04012</td>
      <td>4</td>
      <td>12</td>
      <td>4012</td>
      <td>0</td>
      <td>5.046682</td>
      <td>...</td>
      <td>2.628811</td>
      <td>0.271556</td>
      <td>0.364110</td>
      <td>0.372662</td>
      <td>0.405743</td>
      <td>9.216414</td>
      <td>8.0</td>
      <td>9.296093</td>
      <td>12.379134</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e79bb70&gt;</td>
    </tr>
  </tbody>
</table>
<p>14 rows &#xD7; 70 columns</p>
</div>



<p>Behind the scenes, this uses a fast vectorized library, <code>numexpr</code>, to essentially do the following. </p>
<p>First, compare each row&apos;s <code>STATE_NAME</code> column to <code>&apos;Arizona&apos;</code> and return <code>True</code> if the row matches:</p>
<pre><code class="lang-python">data_table.STATE_NAME == <span class="hljs-string">&apos;Arizona&apos;</span>
</code></pre>
<pre><code>0       False
1       False
2       False
3       False
4       False
5       False
6       False
7       False
8       False
9       False
10      False
11      False
12      False
13      False
14      False
15      False
16      False
17      False
18      False
19      False
20      False
21      False
22      False
23      False
24      False
25      False
26      False
27      False
28      False
29      False
        ...  
3055    False
3056    False
3057    False
3058    False
3059    False
3060    False
3061    False
3062    False
3063    False
3064    False
3065    False
3066    False
3067    False
3068    False
3069    False
3070    False
3071    False
3072    False
3073    False
3074    False
3075    False
3076    False
3077    False
3078    False
3079    False
3080     True
3081    False
3082    False
3083    False
3084    False
Name: STATE_NAME, dtype: bool
</code></pre><p>Then, use that to filter out rows where the condition is true:</p>
<pre><code class="lang-python">data_table[data_table.STATE_NAME == <span class="hljs-string">&apos;Arizona&apos;</span>]
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1707</th>
      <td>Navajo</td>
      <td>Arizona</td>
      <td>04</td>
      <td>017</td>
      <td>04017</td>
      <td>4</td>
      <td>17</td>
      <td>4017</td>
      <td>0</td>
      <td>5.263989</td>
      <td>...</td>
      <td>0.905251</td>
      <td>0.366863</td>
      <td>0.414135</td>
      <td>0.401999</td>
      <td>0.445299</td>
      <td>13.146998</td>
      <td>12.1</td>
      <td>13.762783</td>
      <td>18.033782</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e280080&gt;</td>
    </tr>
    <tr>
      <th>1708</th>
      <td>Coconino</td>
      <td>Arizona</td>
      <td>04</td>
      <td>005</td>
      <td>04005</td>
      <td>4</td>
      <td>5</td>
      <td>4005</td>
      <td>0</td>
      <td>3.185449</td>
      <td>...</td>
      <td>1.469081</td>
      <td>0.301222</td>
      <td>0.377785</td>
      <td>0.381655</td>
      <td>0.403188</td>
      <td>9.475171</td>
      <td>8.5</td>
      <td>11.181563</td>
      <td>15.267643</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2800f0&gt;</td>
    </tr>
    <tr>
      <th>1722</th>
      <td>Mohave</td>
      <td>Arizona</td>
      <td>04</td>
      <td>015</td>
      <td>04015</td>
      <td>4</td>
      <td>15</td>
      <td>4015</td>
      <td>0</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.324075</td>
      <td>0.279339</td>
      <td>0.347150</td>
      <td>0.375790</td>
      <td>0.374383</td>
      <td>11.508554</td>
      <td>4.8</td>
      <td>7.018268</td>
      <td>9.214294</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e280710&gt;</td>
    </tr>
    <tr>
      <th>1726</th>
      <td>Apache</td>
      <td>Arizona</td>
      <td>04</td>
      <td>001</td>
      <td>04001</td>
      <td>4</td>
      <td>1</td>
      <td>4001</td>
      <td>0</td>
      <td>10.951223</td>
      <td>...</td>
      <td>0.162361</td>
      <td>0.395913</td>
      <td>0.450552</td>
      <td>0.431013</td>
      <td>0.489132</td>
      <td>15.014738</td>
      <td>14.6</td>
      <td>18.727548</td>
      <td>22.933635</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2808d0&gt;</td>
    </tr>
    <tr>
      <th>2002</th>
      <td>Yavapai</td>
      <td>Arizona</td>
      <td>04</td>
      <td>025</td>
      <td>04025</td>
      <td>4</td>
      <td>25</td>
      <td>4025</td>
      <td>0</td>
      <td>3.458771</td>
      <td>...</td>
      <td>0.298011</td>
      <td>0.289509</td>
      <td>0.378195</td>
      <td>0.376313</td>
      <td>0.384089</td>
      <td>9.930032</td>
      <td>8.6</td>
      <td>7.516372</td>
      <td>9.483521</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e394518&gt;</td>
    </tr>
    <tr>
      <th>2182</th>
      <td>Gila</td>
      <td>Arizona</td>
      <td>04</td>
      <td>007</td>
      <td>04007</td>
      <td>4</td>
      <td>7</td>
      <td>4007</td>
      <td>0</td>
      <td>6.473749</td>
      <td>...</td>
      <td>0.246171</td>
      <td>0.265294</td>
      <td>0.337519</td>
      <td>0.353848</td>
      <td>0.386976</td>
      <td>10.470261</td>
      <td>8.1</td>
      <td>9.934237</td>
      <td>11.706102</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4500b8&gt;</td>
    </tr>
    <tr>
      <th>2262</th>
      <td>Maricopa</td>
      <td>Arizona</td>
      <td>04</td>
      <td>013</td>
      <td>04013</td>
      <td>4</td>
      <td>13</td>
      <td>4013</td>
      <td>0</td>
      <td>6.179259</td>
      <td>...</td>
      <td>3.499221</td>
      <td>0.277828</td>
      <td>0.352374</td>
      <td>0.366015</td>
      <td>0.372756</td>
      <td>10.642382</td>
      <td>9.8</td>
      <td>11.857260</td>
      <td>14.404902</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e49d438&gt;</td>
    </tr>
    <tr>
      <th>2311</th>
      <td>Greenlee</td>
      <td>Arizona</td>
      <td>04</td>
      <td>011</td>
      <td>04011</td>
      <td>4</td>
      <td>11</td>
      <td>4011</td>
      <td>0</td>
      <td>2.896284</td>
      <td>...</td>
      <td>0.349650</td>
      <td>0.177691</td>
      <td>0.257158</td>
      <td>0.283518</td>
      <td>0.337256</td>
      <td>9.806115</td>
      <td>6.7</td>
      <td>5.295110</td>
      <td>10.453284</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4c1a58&gt;</td>
    </tr>
    <tr>
      <th>2326</th>
      <td>Graham</td>
      <td>Arizona</td>
      <td>04</td>
      <td>009</td>
      <td>04009</td>
      <td>4</td>
      <td>9</td>
      <td>4009</td>
      <td>0</td>
      <td>4.746648</td>
      <td>...</td>
      <td>1.890487</td>
      <td>0.310256</td>
      <td>0.362926</td>
      <td>0.383554</td>
      <td>0.408379</td>
      <td>11.979335</td>
      <td>10.1</td>
      <td>11.961367</td>
      <td>16.129032</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ea128&gt;</td>
    </tr>
    <tr>
      <th>2353</th>
      <td>Pinal</td>
      <td>Arizona</td>
      <td>04</td>
      <td>021</td>
      <td>04021</td>
      <td>4</td>
      <td>21</td>
      <td>4021</td>
      <td>0</td>
      <td>13.828390</td>
      <td>...</td>
      <td>3.134586</td>
      <td>0.304294</td>
      <td>0.369974</td>
      <td>0.361193</td>
      <td>0.400130</td>
      <td>10.822965</td>
      <td>8.8</td>
      <td>10.341699</td>
      <td>15.304144</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ead68&gt;</td>
    </tr>
    <tr>
      <th>2499</th>
      <td>Pima</td>
      <td>Arizona</td>
      <td>04</td>
      <td>019</td>
      <td>04019</td>
      <td>4</td>
      <td>19</td>
      <td>4019</td>
      <td>0</td>
      <td>5.520841</td>
      <td>...</td>
      <td>3.118252</td>
      <td>0.268266</td>
      <td>0.367218</td>
      <td>0.375039</td>
      <td>0.392144</td>
      <td>11.381626</td>
      <td>10.2</td>
      <td>12.689768</td>
      <td>16.163178</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e575e80&gt;</td>
    </tr>
    <tr>
      <th>2514</th>
      <td>Cochise</td>
      <td>Arizona</td>
      <td>04</td>
      <td>003</td>
      <td>04003</td>
      <td>4</td>
      <td>3</td>
      <td>4003</td>
      <td>0</td>
      <td>4.845049</td>
      <td>...</td>
      <td>5.201590</td>
      <td>0.261208</td>
      <td>0.359500</td>
      <td>0.359701</td>
      <td>0.399208</td>
      <td>10.197573</td>
      <td>8.7</td>
      <td>9.912732</td>
      <td>13.733872</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e59b550&gt;</td>
    </tr>
    <tr>
      <th>2615</th>
      <td>Santa Cruz</td>
      <td>Arizona</td>
      <td>04</td>
      <td>023</td>
      <td>04023</td>
      <td>4</td>
      <td>23</td>
      <td>4023</td>
      <td>0</td>
      <td>9.252406</td>
      <td>...</td>
      <td>0.326863</td>
      <td>0.327130</td>
      <td>0.396807</td>
      <td>0.393240</td>
      <td>0.413795</td>
      <td>19.007213</td>
      <td>14.7</td>
      <td>15.690913</td>
      <td>18.272244</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e60a2e8&gt;</td>
    </tr>
    <tr>
      <th>3080</th>
      <td>La Paz</td>
      <td>Arizona</td>
      <td>04</td>
      <td>012</td>
      <td>04012</td>
      <td>4</td>
      <td>12</td>
      <td>4012</td>
      <td>0</td>
      <td>5.046682</td>
      <td>...</td>
      <td>2.628811</td>
      <td>0.271556</td>
      <td>0.364110</td>
      <td>0.372662</td>
      <td>0.405743</td>
      <td>9.216414</td>
      <td>8.0</td>
      <td>9.296093</td>
      <td>12.379134</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e79bb70&gt;</td>
    </tr>
  </tbody>
</table>
<p>14 rows &#xD7; 70 columns</p>
</div>



<p>We might need this behind the scenes knowledge when we want to chain together conditions, or when we need to do spatial queries. </p>
<p>This is because spatial queries are somewhat more complex. Let&apos;s say, for example, we want all of the counties in the US to the West of <code>-121</code> longitude. We need a way to express that question. Ideally, we want something like:</p>
<pre><code>SELECT
        *
FROM
        data_table
WHERE
        x_centroid &lt; -121
</code></pre><p>So, let&apos;s refer to an arbitrary polygon in the the dataframe&apos;s geometry column as <code>poly</code>. The centroid of a PySAL polygon is stored as an <code>(X,Y)</code> pair, so the longitude is the first element of the pair, <code>poly.centroid[0]</code>. </p>
<p>Then, applying this condition to each geometry, we get the same kind of filter we used above to grab only counties in Arizona:</p>
<pre><code class="lang-python">data_table.geometry.apply(<span class="hljs-keyword">lambda</span> x: x.centroid[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">-121</span>)\
                   .head()
</code></pre>
<pre><code>0    False
1    False
2    False
3    False
4    False
Name: geometry, dtype: bool
</code></pre><p>If we use this as a filter on the table, we can get only the rows that match that condition, just like we did for the <code>STATE_NAME</code> query:</p>
<pre><code class="lang-python">data_table[data_table.geometry.apply(<span class="hljs-keyword">lambda</span> x: x.centroid[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">-119</span>)].head()
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>Okanogan</td>
      <td>Washington</td>
      <td>53</td>
      <td>047</td>
      <td>53047</td>
      <td>53</td>
      <td>47</td>
      <td>53047</td>
      <td>0</td>
      <td>2.612330</td>
      <td>...</td>
      <td>0.155922</td>
      <td>0.258540</td>
      <td>0.371218</td>
      <td>0.381240</td>
      <td>0.394519</td>
      <td>9.039900</td>
      <td>8.1</td>
      <td>10.084926</td>
      <td>12.840340</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10dadd5c0&gt;</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Whatcom</td>
      <td>Washington</td>
      <td>53</td>
      <td>073</td>
      <td>53073</td>
      <td>53</td>
      <td>73</td>
      <td>53073</td>
      <td>0</td>
      <td>1.422131</td>
      <td>...</td>
      <td>0.508687</td>
      <td>0.247630</td>
      <td>0.346935</td>
      <td>0.369436</td>
      <td>0.358418</td>
      <td>9.174415</td>
      <td>7.1</td>
      <td>9.718054</td>
      <td>11.135022</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10df05080&gt;</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Skagit</td>
      <td>Washington</td>
      <td>53</td>
      <td>057</td>
      <td>53057</td>
      <td>53</td>
      <td>57</td>
      <td>53057</td>
      <td>0</td>
      <td>2.596560</td>
      <td>...</td>
      <td>0.351958</td>
      <td>0.239346</td>
      <td>0.344830</td>
      <td>0.364623</td>
      <td>0.362265</td>
      <td>8.611518</td>
      <td>7.9</td>
      <td>10.480031</td>
      <td>11.382484</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10df05240&gt;</td>
    </tr>
    <tr>
      <th>42</th>
      <td>Chelan</td>
      <td>Washington</td>
      <td>53</td>
      <td>007</td>
      <td>53007</td>
      <td>53</td>
      <td>7</td>
      <td>53007</td>
      <td>0</td>
      <td>4.908698</td>
      <td>...</td>
      <td>0.153110</td>
      <td>0.246292</td>
      <td>0.367681</td>
      <td>0.374505</td>
      <td>0.383486</td>
      <td>8.787907</td>
      <td>8.1</td>
      <td>9.968454</td>
      <td>12.236493</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10df05710&gt;</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Clallam</td>
      <td>Washington</td>
      <td>53</td>
      <td>009</td>
      <td>53009</td>
      <td>53</td>
      <td>9</td>
      <td>53009</td>
      <td>0</td>
      <td>3.330891</td>
      <td>...</td>
      <td>0.568504</td>
      <td>0.240573</td>
      <td>0.349320</td>
      <td>0.361619</td>
      <td>0.366854</td>
      <td>8.788882</td>
      <td>6.5</td>
      <td>9.660900</td>
      <td>12.281690</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10df057f0&gt;</td>
    </tr>
  </tbody>
</table>
<p>5 rows &#xD7; 70 columns</p>
</div>




<pre><code class="lang-python">len(data_table[data_table.geometry.apply(<span class="hljs-keyword">lambda</span> x: x.centroid[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">-119</span>)]) <span class="hljs-comment">#how many west of -119?</span>
</code></pre>
<pre><code>109
</code></pre><h2 id="other-types-of-spatial-queries">Other types of spatial queries</h2>
<p>Everybody knows the following statements are true:</p>
<ol>
<li>If you head directly west from Reno, Nevada, you will shortly enter California.</li>
<li>San Diego is in California.</li>
</ol>
<p>But what does this tell us about the location of San Diego relative to Reno?</p>
<p>Or for that matter, how many counties in California are to the east of Reno?</p>
<pre><code class="lang-python">geom = data_table.query(<span class="hljs-string">&apos;(NAME == &quot;Washoe&quot;) &amp; (STATE_NAME == &quot;Nevada&quot;)&apos;</span>).geometry
</code></pre>
<pre><code class="lang-python">lon,lat = geom.values[<span class="hljs-number">0</span>].centroid
</code></pre>
<pre><code class="lang-python">lon
</code></pre>
<pre><code>-119.6555030699793
</code></pre><pre><code class="lang-python">cal_counties = data_table.query(<span class="hljs-string">&apos;(STATE_NAME==&quot;California&quot;)&apos;</span>)
</code></pre>
<pre><code class="lang-python">cal_counties[cal_counties.geometry.apply(<span class="hljs-keyword">lambda</span> x: x.centroid[<span class="hljs-number">0</span>] &gt; lon)]
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1312</th>
      <td>Mono</td>
      <td>California</td>
      <td>06</td>
      <td>051</td>
      <td>06051</td>
      <td>6</td>
      <td>51</td>
      <td>6051</td>
      <td>0</td>
      <td>15.062509</td>
      <td>...</td>
      <td>0.431900</td>
      <td>0.229888</td>
      <td>0.327520</td>
      <td>0.388414</td>
      <td>0.366316</td>
      <td>6.743421</td>
      <td>6.6</td>
      <td>8.187135</td>
      <td>10.083699</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10dfd5e48&gt;</td>
    </tr>
    <tr>
      <th>1591</th>
      <td>Fresno</td>
      <td>California</td>
      <td>06</td>
      <td>019</td>
      <td>06019</td>
      <td>6</td>
      <td>19</td>
      <td>6019</td>
      <td>0</td>
      <td>5.192037</td>
      <td>...</td>
      <td>5.007266</td>
      <td>0.286651</td>
      <td>0.379884</td>
      <td>0.394981</td>
      <td>0.412947</td>
      <td>11.788963</td>
      <td>11.8</td>
      <td>13.998747</td>
      <td>18.523541</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e0ecc50&gt;</td>
    </tr>
    <tr>
      <th>1620</th>
      <td>Inyo</td>
      <td>California</td>
      <td>06</td>
      <td>027</td>
      <td>06027</td>
      <td>6</td>
      <td>27</td>
      <td>6027</td>
      <td>0</td>
      <td>8.558713</td>
      <td>...</td>
      <td>0.432143</td>
      <td>0.242293</td>
      <td>0.334361</td>
      <td>0.353784</td>
      <td>0.378516</td>
      <td>9.676365</td>
      <td>8.1</td>
      <td>8.480065</td>
      <td>12.067279</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e220940&gt;</td>
    </tr>
    <tr>
      <th>1765</th>
      <td>Tulare</td>
      <td>California</td>
      <td>06</td>
      <td>107</td>
      <td>06107</td>
      <td>6</td>
      <td>107</td>
      <td>6107</td>
      <td>0</td>
      <td>3.364944</td>
      <td>...</td>
      <td>1.480503</td>
      <td>0.303303</td>
      <td>0.380229</td>
      <td>0.395059</td>
      <td>0.410811</td>
      <td>10.398757</td>
      <td>9.5</td>
      <td>11.957928</td>
      <td>16.303423</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2a4a58&gt;</td>
    </tr>
    <tr>
      <th>1956</th>
      <td>Kern</td>
      <td>California</td>
      <td>06</td>
      <td>029</td>
      <td>06029</td>
      <td>6</td>
      <td>29</td>
      <td>6029</td>
      <td>0</td>
      <td>6.393044</td>
      <td>...</td>
      <td>5.544117</td>
      <td>0.273083</td>
      <td>0.364603</td>
      <td>0.380617</td>
      <td>0.395393</td>
      <td>10.225236</td>
      <td>10.4</td>
      <td>12.037755</td>
      <td>16.118827</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e348fd0&gt;</td>
    </tr>
    <tr>
      <th>1957</th>
      <td>San Bernardino</td>
      <td>California</td>
      <td>06</td>
      <td>071</td>
      <td>06071</td>
      <td>6</td>
      <td>71</td>
      <td>6071</td>
      <td>0</td>
      <td>3.243373</td>
      <td>...</td>
      <td>8.103188</td>
      <td>0.259038</td>
      <td>0.350927</td>
      <td>0.362389</td>
      <td>0.372659</td>
      <td>9.857519</td>
      <td>10.0</td>
      <td>12.999831</td>
      <td>15.403925</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e36f080&gt;</td>
    </tr>
    <tr>
      <th>2117</th>
      <td>Ventura</td>
      <td>California</td>
      <td>06</td>
      <td>111</td>
      <td>06111</td>
      <td>6</td>
      <td>111</td>
      <td>6111</td>
      <td>0</td>
      <td>3.180374</td>
      <td>...</td>
      <td>2.336118</td>
      <td>0.259643</td>
      <td>0.325908</td>
      <td>0.350430</td>
      <td>0.329175</td>
      <td>10.304761</td>
      <td>8.9</td>
      <td>11.047165</td>
      <td>12.044930</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e40c390&gt;</td>
    </tr>
    <tr>
      <th>2255</th>
      <td>Riverside</td>
      <td>California</td>
      <td>06</td>
      <td>065</td>
      <td>06065</td>
      <td>6</td>
      <td>65</td>
      <td>6065</td>
      <td>0</td>
      <td>4.898903</td>
      <td>...</td>
      <td>5.433210</td>
      <td>0.284000</td>
      <td>0.376737</td>
      <td>0.383226</td>
      <td>0.368177</td>
      <td>9.769959</td>
      <td>9.2</td>
      <td>11.145612</td>
      <td>12.678340</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e49d128&gt;</td>
    </tr>
    <tr>
      <th>2279</th>
      <td>Orange</td>
      <td>California</td>
      <td>06</td>
      <td>059</td>
      <td>06059</td>
      <td>6</td>
      <td>59</td>
      <td>6059</td>
      <td>0</td>
      <td>2.083555</td>
      <td>...</td>
      <td>1.770587</td>
      <td>0.255864</td>
      <td>0.316731</td>
      <td>0.355117</td>
      <td>0.330447</td>
      <td>8.802545</td>
      <td>9.1</td>
      <td>12.405423</td>
      <td>12.974648</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e49dc18&gt;</td>
    </tr>
    <tr>
      <th>2344</th>
      <td>San Diego</td>
      <td>California</td>
      <td>06</td>
      <td>073</td>
      <td>06073</td>
      <td>6</td>
      <td>73</td>
      <td>6073</td>
      <td>0</td>
      <td>2.387842</td>
      <td>...</td>
      <td>6.377301</td>
      <td>0.269147</td>
      <td>0.352428</td>
      <td>0.382815</td>
      <td>0.368301</td>
      <td>11.425041</td>
      <td>11.5</td>
      <td>14.384523</td>
      <td>15.489702</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ea908&gt;</td>
    </tr>
    <tr>
      <th>2351</th>
      <td>Los Angeles</td>
      <td>California</td>
      <td>06</td>
      <td>037</td>
      <td>06037</td>
      <td>6</td>
      <td>37</td>
      <td>6037</td>
      <td>0</td>
      <td>4.564947</td>
      <td>...</td>
      <td>11.203381</td>
      <td>0.267207</td>
      <td>0.353837</td>
      <td>0.402031</td>
      <td>0.392669</td>
      <td>13.071850</td>
      <td>13.4</td>
      <td>17.767317</td>
      <td>18.808224</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4eac18&gt;</td>
    </tr>
    <tr>
      <th>2358</th>
      <td>Imperial</td>
      <td>California</td>
      <td>06</td>
      <td>025</td>
      <td>06025</td>
      <td>6</td>
      <td>25</td>
      <td>6025</td>
      <td>0</td>
      <td>4.160599</td>
      <td>...</td>
      <td>2.398836</td>
      <td>0.286568</td>
      <td>0.374913</td>
      <td>0.397430</td>
      <td>0.426348</td>
      <td>11.466417</td>
      <td>9.7</td>
      <td>12.590249</td>
      <td>17.243741</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4eaf98&gt;</td>
    </tr>
  </tbody>
</table>
<p>12 rows &#xD7; 70 columns</p>
</div>




<pre><code class="lang-python">len(cal_counties)
</code></pre>
<pre><code>58
</code></pre><p>This works on any type of spatial query. </p>
<p>For instance, if we wanted to find all of the counties that are within a threshold distance from an observation&apos;s centroid, we can do it in the following way. </p>
<p>But first, we need to handle distance calculations on the earth&apos;s surface.</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> math <span class="hljs-keyword">import</span> radians, sin, cos, sqrt, asin

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gcd</span><span class="hljs-params">(loc1, loc2, R=<span class="hljs-number">3961</span>)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;Great circle distance via Haversine formula

    Parameters
    ----------

    loc1: tuple (long, lat in decimal degrees)

    loc2: tuple (long, lat in decimal degrees)

    R: Radius of the earth (3961 miles, 6367 km)

    Returns
    -------
    great circle distance between loc1 and loc2 in units of R


    Notes
    ------
    Does not take into account non-spheroidal shape of the Earth



    &gt;&gt;&gt; san_diego = -117.1611, 32.7157
    &gt;&gt;&gt; austin = -97.7431, 30.2672
    &gt;&gt;&gt; gcd(san_diego, austin)
    1155.474644164695


    &quot;&quot;&quot;</span>
    lon1, lat1 = loc1
    lon2, lat2 = loc2
    dLat = radians(lat2 - lat1)
    dLon = radians(lon2 - lon1)
    lat1 = radians(lat1)
    lat2 = radians(lat2)

    a = sin(dLat/<span class="hljs-number">2</span>)**<span class="hljs-number">2</span> + cos(lat1)*cos(lat2)*sin(dLon/<span class="hljs-number">2</span>)**<span class="hljs-number">2</span>
    c = <span class="hljs-number">2</span>*asin(sqrt(a))

    <span class="hljs-keyword">return</span> R * c

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gcdm</span><span class="hljs-params">(loc1, loc2)</span>:</span>
    <span class="hljs-keyword">return</span> gcd(loc1, loc2)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gcdk</span><span class="hljs-params">(loc1, loc2)</span>:</span>
    <span class="hljs-keyword">return</span> gcd(loc1, loc2, <span class="hljs-number">6367</span> )
</code></pre>
<pre><code class="lang-python">san_diego = <span class="hljs-number">-117.1611</span>, <span class="hljs-number">32.7157</span>
austin = <span class="hljs-number">-97.7431</span>, <span class="hljs-number">30.2672</span>
gcd(san_diego, austin)
</code></pre>
<pre><code>1155.474644164695
</code></pre><pre><code class="lang-python">gcdk(san_diego, austin)
</code></pre>
<pre><code>1857.3357887898544
</code></pre><pre><code class="lang-python">loc1 = (<span class="hljs-number">-117.1611</span>, <span class="hljs-number">0.0</span>)
loc2 = (<span class="hljs-number">-118.1611</span>, <span class="hljs-number">0.0</span>)
gcd(loc1, loc2)
</code></pre>
<pre><code>69.13249167149539
</code></pre><pre><code class="lang-python">loc1 = (<span class="hljs-number">-117.1611</span>, <span class="hljs-number">45.0</span>)
loc2 = (<span class="hljs-number">-118.1611</span>, <span class="hljs-number">45.0</span>)
gcd(loc1, loc2)
</code></pre>
<pre><code>48.88374342930467
</code></pre><pre><code class="lang-python">loc1 = (<span class="hljs-number">-117.1611</span>, <span class="hljs-number">89.0</span>)
loc2 = (<span class="hljs-number">-118.1611</span>, <span class="hljs-number">89.0</span>)
gcd(loc1, loc2)
</code></pre>
<pre><code>1.2065130336642724
</code></pre><pre><code class="lang-python">lats = range(<span class="hljs-number">0</span>, <span class="hljs-number">91</span>)
onedeglon = [ gcd((<span class="hljs-number">-117.1611</span>,lat),(<span class="hljs-number">-118.1611</span>,lat)) <span class="hljs-keyword">for</span> lat <span class="hljs-keyword">in</span> lats]
</code></pre>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
%matplotlib inline
plt.plot(lats, onedeglon)
plt.ylabel(<span class="hljs-string">&apos;miles&apos;</span>)
plt.xlabel(<span class="hljs-string">&apos;degree of latitude&apos;</span>)
plt.title(<span class="hljs-string">&apos;Length of a degree of longitude&apos;</span>)
</code></pre>
<pre><code>&lt;matplotlib.text.Text at 0x114174470&gt;
</code></pre><p><img src="01_data_processing_files/01_data_processing_87_1.png" alt="png"></p>
<pre><code class="lang-python">san_diego = <span class="hljs-number">-117.1611</span>, <span class="hljs-number">32.7157</span>
austin = <span class="hljs-number">-97.7431</span>, <span class="hljs-number">30.2672</span>
gcd(san_diego, austin)
</code></pre>
<pre><code>1155.474644164695
</code></pre><p>Now we can use our distance function to pose distance-related queries on our data table.</p>
<pre><code class="lang-python"><span class="hljs-comment"># Find all the counties with centroids within 50 miles of Austin</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">near_target_point</span><span class="hljs-params">(polygon, target=austin, threshold=<span class="hljs-number">50</span>)</span>:</span>
    <span class="hljs-keyword">return</span> gcd(polygon.centroid, target) &lt; threshold 

data_table[data_table.geometry.apply(near_target_point)]
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2698</th>
      <td>Burnet</td>
      <td>Texas</td>
      <td>48</td>
      <td>053</td>
      <td>48053</td>
      <td>48</td>
      <td>53</td>
      <td>48053</td>
      <td>1</td>
      <td>0.000000</td>
      <td>...</td>
      <td>1.186224</td>
      <td>0.327508</td>
      <td>0.449285</td>
      <td>0.385079</td>
      <td>0.405890</td>
      <td>10.774142</td>
      <td>6.5</td>
      <td>7.115629</td>
      <td>10.568742</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6567f0&gt;</td>
    </tr>
    <tr>
      <th>2716</th>
      <td>Williamson</td>
      <td>Texas</td>
      <td>48</td>
      <td>491</td>
      <td>48491</td>
      <td>48</td>
      <td>491</td>
      <td>48491</td>
      <td>1</td>
      <td>9.511852</td>
      <td>...</td>
      <td>4.916482</td>
      <td>0.363603</td>
      <td>0.379902</td>
      <td>0.341976</td>
      <td>0.345201</td>
      <td>13.532731</td>
      <td>9.0</td>
      <td>7.582572</td>
      <td>12.032589</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e656fd0&gt;</td>
    </tr>
    <tr>
      <th>2742</th>
      <td>Travis</td>
      <td>Texas</td>
      <td>48</td>
      <td>453</td>
      <td>48453</td>
      <td>48</td>
      <td>453</td>
      <td>48453</td>
      <td>1</td>
      <td>4.242561</td>
      <td>...</td>
      <td>10.959791</td>
      <td>0.299292</td>
      <td>0.372293</td>
      <td>0.378953</td>
      <td>0.388149</td>
      <td>12.976379</td>
      <td>10.9</td>
      <td>14.459691</td>
      <td>17.307113</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e67eba8&gt;</td>
    </tr>
    <tr>
      <th>2751</th>
      <td>Lee</td>
      <td>Texas</td>
      <td>48</td>
      <td>287</td>
      <td>48287</td>
      <td>48</td>
      <td>287</td>
      <td>48287</td>
      <td>1</td>
      <td>7.449622</td>
      <td>...</td>
      <td>13.847829</td>
      <td>0.376002</td>
      <td>0.433132</td>
      <td>0.394000</td>
      <td>0.394959</td>
      <td>12.305699</td>
      <td>10.1</td>
      <td>8.875542</td>
      <td>10.530896</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e67eef0&gt;</td>
    </tr>
    <tr>
      <th>2754</th>
      <td>Blanco</td>
      <td>Texas</td>
      <td>48</td>
      <td>031</td>
      <td>48031</td>
      <td>48</td>
      <td>31</td>
      <td>48031</td>
      <td>1</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.937709</td>
      <td>0.369814</td>
      <td>0.436449</td>
      <td>0.394609</td>
      <td>0.394414</td>
      <td>9.365854</td>
      <td>6.0</td>
      <td>8.074074</td>
      <td>9.080119</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6aa160&gt;</td>
    </tr>
    <tr>
      <th>2762</th>
      <td>Bastrop</td>
      <td>Texas</td>
      <td>48</td>
      <td>021</td>
      <td>48021</td>
      <td>48</td>
      <td>21</td>
      <td>48021</td>
      <td>1</td>
      <td>3.938946</td>
      <td>...</td>
      <td>11.792071</td>
      <td>0.370264</td>
      <td>0.419933</td>
      <td>0.390927</td>
      <td>0.380907</td>
      <td>14.747191</td>
      <td>12.5</td>
      <td>10.559006</td>
      <td>12.281387</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6aa518&gt;</td>
    </tr>
    <tr>
      <th>2769</th>
      <td>Hays</td>
      <td>Texas</td>
      <td>48</td>
      <td>209</td>
      <td>48209</td>
      <td>48</td>
      <td>209</td>
      <td>48209</td>
      <td>1</td>
      <td>5.016555</td>
      <td>...</td>
      <td>3.383424</td>
      <td>0.385061</td>
      <td>0.424973</td>
      <td>0.378992</td>
      <td>0.372266</td>
      <td>13.064187</td>
      <td>9.4</td>
      <td>10.003691</td>
      <td>10.337188</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6aa908&gt;</td>
    </tr>
    <tr>
      <th>2795</th>
      <td>Caldwell</td>
      <td>Texas</td>
      <td>48</td>
      <td>055</td>
      <td>48055</td>
      <td>48</td>
      <td>55</td>
      <td>48055</td>
      <td>1</td>
      <td>9.677544</td>
      <td>...</td>
      <td>10.704001</td>
      <td>0.380080</td>
      <td>0.412614</td>
      <td>0.410802</td>
      <td>0.413940</td>
      <td>15.229616</td>
      <td>10.5</td>
      <td>12.894034</td>
      <td>17.191502</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6d04a8&gt;</td>
    </tr>
    <tr>
      <th>2798</th>
      <td>Comal</td>
      <td>Texas</td>
      <td>48</td>
      <td>091</td>
      <td>48091</td>
      <td>48</td>
      <td>91</td>
      <td>48091</td>
      <td>1</td>
      <td>3.359538</td>
      <td>...</td>
      <td>0.854684</td>
      <td>0.274182</td>
      <td>0.359174</td>
      <td>0.375810</td>
      <td>0.380032</td>
      <td>11.315107</td>
      <td>7.6</td>
      <td>8.693149</td>
      <td>9.104427</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6d05f8&gt;</td>
    </tr>
    <tr>
      <th>2808</th>
      <td>Guadalupe</td>
      <td>Texas</td>
      <td>48</td>
      <td>187</td>
      <td>48187</td>
      <td>48</td>
      <td>187</td>
      <td>48187</td>
      <td>1</td>
      <td>5.743759</td>
      <td>...</td>
      <td>5.649500</td>
      <td>0.340374</td>
      <td>0.388821</td>
      <td>0.354559</td>
      <td>0.378073</td>
      <td>11.758921</td>
      <td>9.6</td>
      <td>10.418149</td>
      <td>12.918448</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6d0a58&gt;</td>
    </tr>
  </tbody>
</table>
<p>10 rows &#xD7; 70 columns</p>
</div>



<h3 id="moving-in-and-out-of-the-dataframe">Moving in and out of the dataframe</h3>
<p>Most things in PySAL will be explicit about what type their input should be. Most of the time, PySAL functions require either lists or arrays. This is why the file-handler methods are the default IO method in PySAL: the rest of the computational tools are built around their datatypes. </p>
<p>However, it is very easy to get the correct datatype from Pandas using the <code>values</code> and <code>tolist</code> commands. </p>
<p><code>tolist()</code> will convert its entries to a list. But, it can only be called on individual columns (called <code>Series</code> in <code>pandas</code> documentation).</p>
<p>So, to turn the <code>NAME</code> column into a list:</p>
<pre><code class="lang-python">data_table.NAME.tolist()[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[&apos;Lake of the Woods&apos;,
 &apos;Ferry&apos;,
 &apos;Stevens&apos;,
 &apos;Okanogan&apos;,
 &apos;Pend Oreille&apos;,
 &apos;Boundary&apos;,
 &apos;Lincoln&apos;,
 &apos;Flathead&apos;,
 &apos;Glacier&apos;,
 &apos;Toole&apos;]
</code></pre><p>To extract many columns, you must select the columns you want and call their <code>.values</code> attribute. </p>
<p>If we were interested in grabbing all of the <code>HR</code> variables in the dataframe, we could first select those column names:</p>
<pre><code class="lang-python">HRs = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> data_table.columns <span class="hljs-keyword">if</span> col.startswith(<span class="hljs-string">&apos;HR&apos;</span>)]
HRs
</code></pre>
<pre><code>[&apos;HR60&apos;, &apos;HR70&apos;, &apos;HR80&apos;, &apos;HR90&apos;]
</code></pre><p>We can use this to focus only on the columns we want:</p>
<pre><code class="lang-python">data_table[HRs].head()
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>HR60</th>
      <th>HR70</th>
      <th>HR80</th>
      <th>HR90</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>8.855827</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>17.208742</td>
      <td>15.885624</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.863863</td>
      <td>1.915158</td>
      <td>3.450775</td>
      <td>6.462453</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.612330</td>
      <td>1.288643</td>
      <td>3.263814</td>
      <td>6.996502</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>7.770008</td>
      <td>7.478033</td>
    </tr>
  </tbody>
</table>
</div>



<p>With this, calling <code>.values</code> gives an array containing all of the entries in this subset of the table:</p>
<pre><code class="lang-python">data_table[[<span class="hljs-string">&apos;HR90&apos;</span>, <span class="hljs-string">&apos;HR80&apos;</span>]].values
</code></pre>
<pre><code>array([[  0.        ,   8.85582713],
       [ 15.88562351,  17.20874204],
       [  6.46245315,   3.4507747 ],
       ..., 
       [  4.36732988,   5.2803488 ],
       [  3.72771194,   3.00003   ],
       [  2.04885495,   1.19474313]])
</code></pre><p>Using the PySAL pdio tools means that if you&apos;re comfortable with working in Pandas, you can continue to do so. </p>
<p>If you&apos;re more comfortable using Numpy or raw Python to do your data processing, PySAL&apos;s IO tools naturally support this. </p>
<h2 id="exercises">Exercises</h2>
<ol>
<li>Find the county with the western most centroid that is within 1000 miles of Austin.</li>
<li><h1 id="find-the-distance-between-austin-and-that-centroid">Find the distance between Austin and that centroid.</h1>
</li>
</ol>
<h1 id="spatial-data-processing-with-pysal--pandas">Spatial Data Processing with PySAL &amp; Pandas</h1>
<blockquote>
<p><a href="../content/part1/01_data_processing.ipynb"><code>IPYNB</code></a></p>
</blockquote>
<pre><code class="lang-python"><span class="hljs-comment">#by convention, we use these shorter two-letter names</span>
<span class="hljs-keyword">import</span> pysal <span class="hljs-keyword">as</span> ps
<span class="hljs-keyword">import</span> libpysal <span class="hljs-keyword">as</span> lps
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
</code></pre>
<p>PySAL has two simple ways to read in data. But, first, you need to get the path from where your notebook is running on your computer to the place the data is. For example, to find where the notebook is running:</p>
<pre><code class="lang-python">!pwd <span class="hljs-comment"># on windows !cd</span>
</code></pre>
<pre><code>/Users/dani/code/gds_scipy16/content/part1
</code></pre><p>PySAL has a command that it uses to get the paths of its example datasets. Let&apos;s work with a commonly-used dataset first. </p>
<pre><code class="lang-python">lps.examples.available()
</code></pre>
<pre><code>[&apos;10740&apos;,
 &apos;arcgis&apos;,
 &apos;baltim&apos;,
 &apos;book&apos;,
 &apos;burkitt&apos;,
 &apos;calemp&apos;,
 &apos;chicago&apos;,
 &apos;columbus&apos;,
 &apos;desmith&apos;,
 &apos;geodanet&apos;,
 &apos;juvenile&apos;,
 &apos;Line&apos;,
 &apos;mexico&apos;,
 &apos;nat&apos;,
 &apos;networks&apos;,
 &apos;newHaven&apos;,
 &apos;Point&apos;,
 &apos;Polygon&apos;,
 &apos;sacramento2&apos;,
 &apos;sids2&apos;,
 &apos;snow_maps&apos;,
 &apos;south&apos;,
 &apos;stl&apos;,
 &apos;street_net_pts&apos;,
 &apos;taz&apos;,
 &apos;us_income&apos;,
 &apos;virginia&apos;,
 &apos;wmat&apos;]
</code></pre><pre><code class="lang-python">lps.examples.explain(<span class="hljs-string">&apos;us_income&apos;</span>)
</code></pre>
<pre><code>{&apos;description&apos;: &apos;Per-capita income for the lower 47 US states 1929-2010&apos;,
 &apos;explanation&apos;: [&apos; * us48.shp: shapefile &apos;,
  &apos; * us48.dbf: dbf for shapefile&apos;,
  &apos; * us48.shx: index for shapefile&apos;,
  &apos; * usjoin.csv: attribute data (comma delimited file)&apos;],
 &apos;name&apos;: &apos;us_income&apos;}
</code></pre><pre><code class="lang-python">csv_path = lps.examples.get_path(<span class="hljs-string">&apos;usjoin.csv&apos;</span>)
</code></pre>
<pre><code class="lang-python">f = lps.io.open(csv_path)
f.header[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[&apos;Name&apos;,
 &apos;STATE_FIPS&apos;,
 &apos;1929&apos;,
 &apos;1930&apos;,
 &apos;1931&apos;,
 &apos;1932&apos;,
 &apos;1933&apos;,
 &apos;1934&apos;,
 &apos;1935&apos;,
 &apos;1936&apos;]
</code></pre><pre><code class="lang-python">y2009 = f.by_col(<span class="hljs-string">&apos;2009&apos;</span>)
</code></pre>
<pre><code class="lang-python">y2009[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[32274, 32077, 31493, 40902, 40093, 52736, 40135, 36565, 33086, 30987]
</code></pre><h3 id="working-with-shapefiles">Working with shapefiles</h3>
<p>We can also work with local files outside the built-in examples.</p>
<p>To read in a shapefile, we will need the path to the file.</p>
<pre><code class="lang-python">shp_path = <span class="hljs-string">&apos;../data/texas.shp&apos;</span>
print(shp_path)
</code></pre>
<pre><code>../data/texas.shp
</code></pre><p>Then, we open the file using the <code>ps.open</code> command:</p>
<pre><code class="lang-python">f = lps.io.open(shp_path)
</code></pre>
<p><code>f</code> is what we call a &quot;file handle.&quot; That means that it only <em>points</em> to the data and provides ways to work with it. By itself, it does not read the whole dataset into memory. To see basic information about the file, we can use a few different methods. </p>
<p>For instance, the header of the file, which contains most of the metadata about the file:</p>
<pre><code class="lang-python">f.header
</code></pre>
<pre><code>{&apos;BBOX Mmax&apos;: 0.0,
 &apos;BBOX Mmin&apos;: 0.0,
 &apos;BBOX Xmax&apos;: -93.50721740722656,
 &apos;BBOX Xmin&apos;: -106.6495132446289,
 &apos;BBOX Ymax&apos;: 36.49387741088867,
 &apos;BBOX Ymin&apos;: 25.845197677612305,
 &apos;BBOX Zmax&apos;: 0.0,
 &apos;BBOX Zmin&apos;: 0.0,
 &apos;File Code&apos;: 9994,
 &apos;File Length&apos;: 49902,
 &apos;Shape Type&apos;: 5,
 &apos;Unused0&apos;: 0,
 &apos;Unused1&apos;: 0,
 &apos;Unused2&apos;: 0,
 &apos;Unused3&apos;: 0,
 &apos;Unused4&apos;: 0,
 &apos;Version&apos;: 1000}
</code></pre><p>To actually read in the shapes from memory, you can use the following commands:</p>
<pre><code class="lang-python">f.by_row(<span class="hljs-number">14</span>) <span class="hljs-comment">#gets the 14th shape from the file</span>
</code></pre>
<pre><code>&lt;pysal.cg.shapes.Polygon at 0x10d8baa20&gt;
</code></pre><pre><code class="lang-python">all_polygons = f.read() <span class="hljs-comment">#reads in all polygons from memory</span>
</code></pre>
<pre><code class="lang-python">len(all_polygons)
</code></pre>
<pre><code>254
</code></pre><p>So, all 254 polygons have been read in from file. These are stored in PySAL shape objects, which can be used by PySAL and can be converted to other Python shape objects.</p>
<p>They typically have a few methods. So, since we&apos;ve read in polygonal data, we can get some properties about the polygons. Let&apos;s just have a look at the first polygon:</p>
<pre><code class="lang-python">all_polygons[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>]
</code></pre>
<pre><code>[&lt;pysal.cg.shapes.Polygon at 0x10d8baba8&gt;,
 &lt;pysal.cg.shapes.Polygon at 0x10d8ba908&gt;,
 &lt;pysal.cg.shapes.Polygon at 0x10d8ba860&gt;,
 &lt;pysal.cg.shapes.Polygon at 0x10d8ba8d0&gt;,
 &lt;pysal.cg.shapes.Polygon at 0x10d8baa90&gt;]
</code></pre><pre><code class="lang-python">all_polygons[<span class="hljs-number">0</span>].centroid <span class="hljs-comment">#the centroid of the first polygon</span>
</code></pre>
<pre><code>(-100.27156110567945, 36.27508640938005)
</code></pre><pre><code class="lang-python">all_polygons[<span class="hljs-number">0</span>].area
</code></pre>
<pre><code>0.23682222998468205
</code></pre><pre><code class="lang-python">all_polygons[<span class="hljs-number">0</span>].perimeter
</code></pre>
<pre><code>1.9582821721538344
</code></pre><p>While in the Jupyter Notebook, you can examine what properties an object has by using the tab key.</p>
<pre><code class="lang-python">polygon = all_polygons[<span class="hljs-number">0</span>]
</code></pre>
<pre><code class="lang-python">polygon. <span class="hljs-comment">#press tab when the cursor is right after the dot</span>
</code></pre>
<pre><code>  File &quot;&lt;ipython-input-20-aa03438a2fa8&gt;&quot;, line 1
    polygon. #press tab when the cursor is right after the dot
                                                              ^
SyntaxError: invalid syntax
</code></pre><h3 id="working-with-data-tables">Working with Data Tables</h3>
<pre><code class="lang-python">dbf_path = <span class="hljs-string">&quot;../data/texas.dbf&quot;</span>
print(dbf_path)
</code></pre>
<pre><code>../data/texas.dbf
</code></pre><p>When you&apos;re working with tables of data, like a <code>csv</code> or <code>dbf</code>, you can extract your data in the following way. Let&apos;s open the dbf file we got the path for above.</p>
<pre><code class="lang-python">f = ps.open(dbf_path)
</code></pre>
<p>Just like with the shapefile, we can examine the header of the dbf file.</p>
<pre><code class="lang-python">f.header
</code></pre>
<pre><code>[&apos;NAME&apos;,
 &apos;STATE_NAME&apos;,
 &apos;STATE_FIPS&apos;,
 &apos;CNTY_FIPS&apos;,
 &apos;FIPS&apos;,
 &apos;STFIPS&apos;,
 &apos;COFIPS&apos;,
 &apos;FIPSNO&apos;,
 &apos;SOUTH&apos;,
 &apos;HR60&apos;,
 &apos;HR70&apos;,
 &apos;HR80&apos;,
 &apos;HR90&apos;,
 &apos;HC60&apos;,
 &apos;HC70&apos;,
 &apos;HC80&apos;,
 &apos;HC90&apos;,
 &apos;PO60&apos;,
 &apos;PO70&apos;,
 &apos;PO80&apos;,
 &apos;PO90&apos;,
 &apos;RD60&apos;,
 &apos;RD70&apos;,
 &apos;RD80&apos;,
 &apos;RD90&apos;,
 &apos;PS60&apos;,
 &apos;PS70&apos;,
 &apos;PS80&apos;,
 &apos;PS90&apos;,
 &apos;UE60&apos;,
 &apos;UE70&apos;,
 &apos;UE80&apos;,
 &apos;UE90&apos;,
 &apos;DV60&apos;,
 &apos;DV70&apos;,
 &apos;DV80&apos;,
 &apos;DV90&apos;,
 &apos;MA60&apos;,
 &apos;MA70&apos;,
 &apos;MA80&apos;,
 &apos;MA90&apos;,
 &apos;POL60&apos;,
 &apos;POL70&apos;,
 &apos;POL80&apos;,
 &apos;POL90&apos;,
 &apos;DNL60&apos;,
 &apos;DNL70&apos;,
 &apos;DNL80&apos;,
 &apos;DNL90&apos;,
 &apos;MFIL59&apos;,
 &apos;MFIL69&apos;,
 &apos;MFIL79&apos;,
 &apos;MFIL89&apos;,
 &apos;FP59&apos;,
 &apos;FP69&apos;,
 &apos;FP79&apos;,
 &apos;FP89&apos;,
 &apos;BLK60&apos;,
 &apos;BLK70&apos;,
 &apos;BLK80&apos;,
 &apos;BLK90&apos;,
 &apos;GI59&apos;,
 &apos;GI69&apos;,
 &apos;GI79&apos;,
 &apos;GI89&apos;,
 &apos;FH60&apos;,
 &apos;FH70&apos;,
 &apos;FH80&apos;,
 &apos;FH90&apos;]
</code></pre><p>So, the header is a list containing the names of all of the fields we can read.
If we just wanted to grab the data of interest, <code>HR90</code>, we can use either <code>by_col</code> or <code>by_col_array</code>, depending on the format we want the resulting data in:</p>
<pre><code class="lang-python">HR90 = f.by_col(<span class="hljs-string">&apos;HR90&apos;</span>)
print(type(HR90).__name__, HR90[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>])
HR90 = f.by_col_array(<span class="hljs-string">&apos;HR90&apos;</span>)
print(type(HR90).__name__, HR90[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>])
</code></pre>
<pre><code>list [0.0, 0.0, 18.31166453, 0.0, 3.6517674554]
ndarray [[  0.        ]
 [  0.        ]
 [ 18.31166453]
 [  0.        ]
 [  3.65176746]]
</code></pre><p>As you can see, the <code>by_col</code> function returns a list of data, with no shape. It can only return one column at a time:</p>
<pre><code class="lang-python">HRs = f.by_col(<span class="hljs-string">&apos;HR90&apos;</span>, <span class="hljs-string">&apos;HR80&apos;</span>)
</code></pre>
<pre><code>---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

&lt;ipython-input-25-1fef6a3c3a50&gt; in &lt;module&gt;()
----&gt; 1 HRs = f.by_col(&apos;HR90&apos;, &apos;HR80&apos;)


TypeError: __call__() takes 2 positional arguments but 3 were given
</code></pre><p>This error message is called a &quot;traceback,&quot; as you see in the top right, and it usually provides feedback on why the previous command did not execute correctly. Here, you see that one-too-many arguments was provided to <code>__call__</code>, which tells us we cannot pass as many arguments as we did to <code>by_col</code>.</p>
<p>If you want to read in many columns at once and store them to an array, use <code>by_col_array</code>:</p>
<pre><code class="lang-python">HRs = f.by_col_array(<span class="hljs-string">&apos;HR90&apos;</span>, <span class="hljs-string">&apos;HR80&apos;</span>)
</code></pre>
<pre><code class="lang-python">HRs[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>array([[  0.        ,   0.        ],
       [  0.        ,  10.50199538],
       [ 18.31166453,   5.10386362],
       [  0.        ,   0.        ],
       [  3.65176746,  10.4297038 ],
       [  0.        ,   0.        ],
       [  0.        ,  18.85369532],
       [  2.59514448,   6.33617194],
       [  0.        ,   0.        ],
       [  5.59753708,   6.0331825 ]])
</code></pre><p>It is best to use <code>by_col_array</code> on data of a single type. That is, if you read in a lot of columns, some of them numbers and some of them strings, all columns will get converted to the same datatype:</p>
<pre><code class="lang-python">allcolumns = f.by_col_array([<span class="hljs-string">&apos;NAME&apos;</span>, <span class="hljs-string">&apos;STATE_NAME&apos;</span>, <span class="hljs-string">&apos;HR90&apos;</span>, <span class="hljs-string">&apos;HR80&apos;</span>])
</code></pre>
<pre><code class="lang-python">allcolumns
</code></pre>
<pre><code>array([[&apos;Lipscomb&apos;, &apos;Texas&apos;, &apos;0.0&apos;, &apos;0.0&apos;],
       [&apos;Sherman&apos;, &apos;Texas&apos;, &apos;0.0&apos;, &apos;10.501995379&apos;],
       [&apos;Dallam&apos;, &apos;Texas&apos;, &apos;18.31166453&apos;, &apos;5.1038636248&apos;],
       ..., 
       [&apos;Hidalgo&apos;, &apos;Texas&apos;, &apos;7.3003167816&apos;, &apos;8.2383277607&apos;],
       [&apos;Willacy&apos;, &apos;Texas&apos;, &apos;5.6481219994&apos;, &apos;7.6212251119&apos;],
       [&apos;Cameron&apos;, &apos;Texas&apos;, &apos;12.302014455&apos;, &apos;11.761321464&apos;]], 
      dtype=&apos;&lt;U13&apos;)
</code></pre><p>Note that the numerical columns, <code>HR90</code> &amp; <code>HR80</code> are now considered strings, since they show up with the single tickmarks around them, like <code>&apos;0.0&apos;</code>.</p>
<p>These methods work similarly for <code>.csv</code> files as well.</p>
<h3 id="using-pandas-with-pysal">Using Pandas with PySAL</h3>
<p>A new functionality added to PySAL recently allows you to work with shapefile/dbf pairs using Pandas. This <em>optional</em> extension is only turned on if you have Pandas installed. The extension is the <code>ps.pdio</code> module:</p>
<pre><code class="lang-python">ps.pdio
</code></pre>
<pre><code>&lt;module &apos;pysal.contrib.pdutilities&apos; from &apos;/Users/dani/anaconda/envs/gds-scipy16/lib/python3.5/site-packages/pysal/contrib/pdutilities/__init__.py&apos;&gt;
</code></pre><p>To use it, you can read in shapefile/dbf pairs using the <code>ps.pdio.read_files</code> command. </p>
<pre><code class="lang-python">shp_path = ps.examples.get_path(<span class="hljs-string">&apos;NAT.shp&apos;</span>)
data_table = ps.pdio.read_files(shp_path)
</code></pre>
<p>This reads in <em>the entire database table</em> and adds a column to the end, called <code>geometry</code>, that stores the geometries read in from the shapefile. </p>
<p>Now, you can work with it like a standard pandas dataframe.</p>
<pre><code class="lang-python">data_table.head()
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Lake of the Woods</td>
      <td>Minnesota</td>
      <td>27</td>
      <td>077</td>
      <td>27077</td>
      <td>27</td>
      <td>77</td>
      <td>27077</td>
      <td>0</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.024534</td>
      <td>0.285235</td>
      <td>0.372336</td>
      <td>0.342104</td>
      <td>0.336455</td>
      <td>11.279621</td>
      <td>5.4</td>
      <td>5.663881</td>
      <td>9.515860</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x104125ef0&gt;</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ferry</td>
      <td>Washington</td>
      <td>53</td>
      <td>019</td>
      <td>53019</td>
      <td>53</td>
      <td>19</td>
      <td>53019</td>
      <td>0</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.317712</td>
      <td>0.256158</td>
      <td>0.360665</td>
      <td>0.361928</td>
      <td>0.360640</td>
      <td>10.053476</td>
      <td>2.6</td>
      <td>10.079576</td>
      <td>11.397059</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10d8ba390&gt;</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Stevens</td>
      <td>Washington</td>
      <td>53</td>
      <td>065</td>
      <td>53065</td>
      <td>53</td>
      <td>65</td>
      <td>53065</td>
      <td>0</td>
      <td>1.863863</td>
      <td>...</td>
      <td>0.210030</td>
      <td>0.283999</td>
      <td>0.394083</td>
      <td>0.357566</td>
      <td>0.369942</td>
      <td>9.258437</td>
      <td>5.6</td>
      <td>6.812127</td>
      <td>10.352015</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x104142400&gt;</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Okanogan</td>
      <td>Washington</td>
      <td>53</td>
      <td>047</td>
      <td>53047</td>
      <td>53</td>
      <td>47</td>
      <td>53047</td>
      <td>0</td>
      <td>2.612330</td>
      <td>...</td>
      <td>0.155922</td>
      <td>0.258540</td>
      <td>0.371218</td>
      <td>0.381240</td>
      <td>0.394519</td>
      <td>9.039900</td>
      <td>8.1</td>
      <td>10.084926</td>
      <td>12.840340</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10dadd5c0&gt;</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Pend Oreille</td>
      <td>Washington</td>
      <td>53</td>
      <td>051</td>
      <td>53051</td>
      <td>53</td>
      <td>51</td>
      <td>53051</td>
      <td>0</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.134605</td>
      <td>0.243263</td>
      <td>0.365614</td>
      <td>0.358706</td>
      <td>0.387848</td>
      <td>8.243930</td>
      <td>4.1</td>
      <td>7.557643</td>
      <td>10.313002</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10dadd630&gt;</td>
    </tr>
  </tbody>
</table>
<p>5 rows &#xD7; 70 columns</p>
</div>



<p>The <code>read_files</code> function only works on shapefile/dbf pairs. If you need to read in data using CSVs, use pandas directly:</p>
<pre><code class="lang-python">usjoin = pd.read_csv(csv_path)
<span class="hljs-comment">#usjoin = ps.pdio.read_files(csv_path) #will not work, not a shp/dbf pair</span>
</code></pre>
<pre><code class="lang-python">usjoin.head()
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Name</th>
      <th>STATE_FIPS</th>
      <th>1929</th>
      <th>1930</th>
      <th>1931</th>
      <th>1932</th>
      <th>1933</th>
      <th>1934</th>
      <th>1935</th>
      <th>1936</th>
      <th>...</th>
      <th>2000</th>
      <th>2001</th>
      <th>2002</th>
      <th>2003</th>
      <th>2004</th>
      <th>2005</th>
      <th>2006</th>
      <th>2007</th>
      <th>2008</th>
      <th>2009</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alabama</td>
      <td>1</td>
      <td>323</td>
      <td>267</td>
      <td>224</td>
      <td>162</td>
      <td>166</td>
      <td>211</td>
      <td>217</td>
      <td>251</td>
      <td>...</td>
      <td>23471</td>
      <td>24467</td>
      <td>25161</td>
      <td>26065</td>
      <td>27665</td>
      <td>29097</td>
      <td>30634</td>
      <td>31988</td>
      <td>32819</td>
      <td>32274</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Arizona</td>
      <td>4</td>
      <td>600</td>
      <td>520</td>
      <td>429</td>
      <td>321</td>
      <td>308</td>
      <td>362</td>
      <td>416</td>
      <td>462</td>
      <td>...</td>
      <td>25578</td>
      <td>26232</td>
      <td>26469</td>
      <td>27106</td>
      <td>28753</td>
      <td>30671</td>
      <td>32552</td>
      <td>33470</td>
      <td>33445</td>
      <td>32077</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Arkansas</td>
      <td>5</td>
      <td>310</td>
      <td>228</td>
      <td>215</td>
      <td>157</td>
      <td>157</td>
      <td>187</td>
      <td>207</td>
      <td>247</td>
      <td>...</td>
      <td>22257</td>
      <td>23532</td>
      <td>23929</td>
      <td>25074</td>
      <td>26465</td>
      <td>27512</td>
      <td>29041</td>
      <td>31070</td>
      <td>31800</td>
      <td>31493</td>
    </tr>
    <tr>
      <th>3</th>
      <td>California</td>
      <td>6</td>
      <td>991</td>
      <td>887</td>
      <td>749</td>
      <td>580</td>
      <td>546</td>
      <td>603</td>
      <td>660</td>
      <td>771</td>
      <td>...</td>
      <td>32275</td>
      <td>32750</td>
      <td>32900</td>
      <td>33801</td>
      <td>35663</td>
      <td>37463</td>
      <td>40169</td>
      <td>41943</td>
      <td>42377</td>
      <td>40902</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Colorado</td>
      <td>8</td>
      <td>634</td>
      <td>578</td>
      <td>471</td>
      <td>354</td>
      <td>353</td>
      <td>368</td>
      <td>444</td>
      <td>542</td>
      <td>...</td>
      <td>32949</td>
      <td>34228</td>
      <td>33963</td>
      <td>34092</td>
      <td>35543</td>
      <td>37388</td>
      <td>39662</td>
      <td>41165</td>
      <td>41719</td>
      <td>40093</td>
    </tr>
  </tbody>
</table>
<p>5 rows &#xD7; 83 columns</p>
</div>



<p>The nice thing about working with pandas dataframes is that they have very powerful baked-in support for relational-style queries. By this, I mean that it is very easy to find things like:</p>
<p>The number of counties in each state:</p>
<pre><code class="lang-python">data_table.groupby(<span class="hljs-string">&quot;STATE_NAME&quot;</span>).size()
</code></pre>
<pre><code>STATE_NAME
Alabama                  67
Arizona                  14
Arkansas                 75
California               58
Colorado                 63
Connecticut               8
Delaware                  3
District of Columbia      1
Florida                  67
Georgia                 159
Idaho                    44
Illinois                102
Indiana                  92
Iowa                     99
Kansas                  105
Kentucky                120
Louisiana                64
Maine                    16
Maryland                 24
Massachusetts            12
Michigan                 83
Minnesota                87
Mississippi              82
Missouri                115
Montana                  55
Nebraska                 93
Nevada                   17
New Hampshire            10
New Jersey               21
New Mexico               32
New York                 58
North Carolina          100
North Dakota             53
Ohio                     88
Oklahoma                 77
Oregon                   36
Pennsylvania             67
Rhode Island              5
South Carolina           46
South Dakota             66
Tennessee                95
Texas                   254
Utah                     29
Vermont                  14
Virginia                123
Washington               38
West Virginia            55
Wisconsin                70
Wyoming                  23
dtype: int64
</code></pre><p>Or, to get the rows of the table that are in Arizona, we can use the <code>query</code> function of the dataframe:</p>
<pre><code class="lang-python">data_table.query(<span class="hljs-string">&apos;STATE_NAME == &quot;Arizona&quot;&apos;</span>)
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1707</th>
      <td>Navajo</td>
      <td>Arizona</td>
      <td>04</td>
      <td>017</td>
      <td>04017</td>
      <td>4</td>
      <td>17</td>
      <td>4017</td>
      <td>0</td>
      <td>5.263989</td>
      <td>...</td>
      <td>0.905251</td>
      <td>0.366863</td>
      <td>0.414135</td>
      <td>0.401999</td>
      <td>0.445299</td>
      <td>13.146998</td>
      <td>12.1</td>
      <td>13.762783</td>
      <td>18.033782</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e280080&gt;</td>
    </tr>
    <tr>
      <th>1708</th>
      <td>Coconino</td>
      <td>Arizona</td>
      <td>04</td>
      <td>005</td>
      <td>04005</td>
      <td>4</td>
      <td>5</td>
      <td>4005</td>
      <td>0</td>
      <td>3.185449</td>
      <td>...</td>
      <td>1.469081</td>
      <td>0.301222</td>
      <td>0.377785</td>
      <td>0.381655</td>
      <td>0.403188</td>
      <td>9.475171</td>
      <td>8.5</td>
      <td>11.181563</td>
      <td>15.267643</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2800f0&gt;</td>
    </tr>
    <tr>
      <th>1722</th>
      <td>Mohave</td>
      <td>Arizona</td>
      <td>04</td>
      <td>015</td>
      <td>04015</td>
      <td>4</td>
      <td>15</td>
      <td>4015</td>
      <td>0</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.324075</td>
      <td>0.279339</td>
      <td>0.347150</td>
      <td>0.375790</td>
      <td>0.374383</td>
      <td>11.508554</td>
      <td>4.8</td>
      <td>7.018268</td>
      <td>9.214294</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e280710&gt;</td>
    </tr>
    <tr>
      <th>1726</th>
      <td>Apache</td>
      <td>Arizona</td>
      <td>04</td>
      <td>001</td>
      <td>04001</td>
      <td>4</td>
      <td>1</td>
      <td>4001</td>
      <td>0</td>
      <td>10.951223</td>
      <td>...</td>
      <td>0.162361</td>
      <td>0.395913</td>
      <td>0.450552</td>
      <td>0.431013</td>
      <td>0.489132</td>
      <td>15.014738</td>
      <td>14.6</td>
      <td>18.727548</td>
      <td>22.933635</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2808d0&gt;</td>
    </tr>
    <tr>
      <th>2002</th>
      <td>Yavapai</td>
      <td>Arizona</td>
      <td>04</td>
      <td>025</td>
      <td>04025</td>
      <td>4</td>
      <td>25</td>
      <td>4025</td>
      <td>0</td>
      <td>3.458771</td>
      <td>...</td>
      <td>0.298011</td>
      <td>0.289509</td>
      <td>0.378195</td>
      <td>0.376313</td>
      <td>0.384089</td>
      <td>9.930032</td>
      <td>8.6</td>
      <td>7.516372</td>
      <td>9.483521</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e394518&gt;</td>
    </tr>
    <tr>
      <th>2182</th>
      <td>Gila</td>
      <td>Arizona</td>
      <td>04</td>
      <td>007</td>
      <td>04007</td>
      <td>4</td>
      <td>7</td>
      <td>4007</td>
      <td>0</td>
      <td>6.473749</td>
      <td>...</td>
      <td>0.246171</td>
      <td>0.265294</td>
      <td>0.337519</td>
      <td>0.353848</td>
      <td>0.386976</td>
      <td>10.470261</td>
      <td>8.1</td>
      <td>9.934237</td>
      <td>11.706102</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4500b8&gt;</td>
    </tr>
    <tr>
      <th>2262</th>
      <td>Maricopa</td>
      <td>Arizona</td>
      <td>04</td>
      <td>013</td>
      <td>04013</td>
      <td>4</td>
      <td>13</td>
      <td>4013</td>
      <td>0</td>
      <td>6.179259</td>
      <td>...</td>
      <td>3.499221</td>
      <td>0.277828</td>
      <td>0.352374</td>
      <td>0.366015</td>
      <td>0.372756</td>
      <td>10.642382</td>
      <td>9.8</td>
      <td>11.857260</td>
      <td>14.404902</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e49d438&gt;</td>
    </tr>
    <tr>
      <th>2311</th>
      <td>Greenlee</td>
      <td>Arizona</td>
      <td>04</td>
      <td>011</td>
      <td>04011</td>
      <td>4</td>
      <td>11</td>
      <td>4011</td>
      <td>0</td>
      <td>2.896284</td>
      <td>...</td>
      <td>0.349650</td>
      <td>0.177691</td>
      <td>0.257158</td>
      <td>0.283518</td>
      <td>0.337256</td>
      <td>9.806115</td>
      <td>6.7</td>
      <td>5.295110</td>
      <td>10.453284</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4c1a58&gt;</td>
    </tr>
    <tr>
      <th>2326</th>
      <td>Graham</td>
      <td>Arizona</td>
      <td>04</td>
      <td>009</td>
      <td>04009</td>
      <td>4</td>
      <td>9</td>
      <td>4009</td>
      <td>0</td>
      <td>4.746648</td>
      <td>...</td>
      <td>1.890487</td>
      <td>0.310256</td>
      <td>0.362926</td>
      <td>0.383554</td>
      <td>0.408379</td>
      <td>11.979335</td>
      <td>10.1</td>
      <td>11.961367</td>
      <td>16.129032</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ea128&gt;</td>
    </tr>
    <tr>
      <th>2353</th>
      <td>Pinal</td>
      <td>Arizona</td>
      <td>04</td>
      <td>021</td>
      <td>04021</td>
      <td>4</td>
      <td>21</td>
      <td>4021</td>
      <td>0</td>
      <td>13.828390</td>
      <td>...</td>
      <td>3.134586</td>
      <td>0.304294</td>
      <td>0.369974</td>
      <td>0.361193</td>
      <td>0.400130</td>
      <td>10.822965</td>
      <td>8.8</td>
      <td>10.341699</td>
      <td>15.304144</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ead68&gt;</td>
    </tr>
    <tr>
      <th>2499</th>
      <td>Pima</td>
      <td>Arizona</td>
      <td>04</td>
      <td>019</td>
      <td>04019</td>
      <td>4</td>
      <td>19</td>
      <td>4019</td>
      <td>0</td>
      <td>5.520841</td>
      <td>...</td>
      <td>3.118252</td>
      <td>0.268266</td>
      <td>0.367218</td>
      <td>0.375039</td>
      <td>0.392144</td>
      <td>11.381626</td>
      <td>10.2</td>
      <td>12.689768</td>
      <td>16.163178</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e575e80&gt;</td>
    </tr>
    <tr>
      <th>2514</th>
      <td>Cochise</td>
      <td>Arizona</td>
      <td>04</td>
      <td>003</td>
      <td>04003</td>
      <td>4</td>
      <td>3</td>
      <td>4003</td>
      <td>0</td>
      <td>4.845049</td>
      <td>...</td>
      <td>5.201590</td>
      <td>0.261208</td>
      <td>0.359500</td>
      <td>0.359701</td>
      <td>0.399208</td>
      <td>10.197573</td>
      <td>8.7</td>
      <td>9.912732</td>
      <td>13.733872</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e59b550&gt;</td>
    </tr>
    <tr>
      <th>2615</th>
      <td>Santa Cruz</td>
      <td>Arizona</td>
      <td>04</td>
      <td>023</td>
      <td>04023</td>
      <td>4</td>
      <td>23</td>
      <td>4023</td>
      <td>0</td>
      <td>9.252406</td>
      <td>...</td>
      <td>0.326863</td>
      <td>0.327130</td>
      <td>0.396807</td>
      <td>0.393240</td>
      <td>0.413795</td>
      <td>19.007213</td>
      <td>14.7</td>
      <td>15.690913</td>
      <td>18.272244</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e60a2e8&gt;</td>
    </tr>
    <tr>
      <th>3080</th>
      <td>La Paz</td>
      <td>Arizona</td>
      <td>04</td>
      <td>012</td>
      <td>04012</td>
      <td>4</td>
      <td>12</td>
      <td>4012</td>
      <td>0</td>
      <td>5.046682</td>
      <td>...</td>
      <td>2.628811</td>
      <td>0.271556</td>
      <td>0.364110</td>
      <td>0.372662</td>
      <td>0.405743</td>
      <td>9.216414</td>
      <td>8.0</td>
      <td>9.296093</td>
      <td>12.379134</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e79bb70&gt;</td>
    </tr>
  </tbody>
</table>
<p>14 rows &#xD7; 70 columns</p>
</div>



<p>Behind the scenes, this uses a fast vectorized library, <code>numexpr</code>, to essentially do the following. </p>
<p>First, compare each row&apos;s <code>STATE_NAME</code> column to <code>&apos;Arizona&apos;</code> and return <code>True</code> if the row matches:</p>
<pre><code class="lang-python">data_table.STATE_NAME == <span class="hljs-string">&apos;Arizona&apos;</span>
</code></pre>
<pre><code>0       False
1       False
2       False
3       False
4       False
5       False
6       False
7       False
8       False
9       False
10      False
11      False
12      False
13      False
14      False
15      False
16      False
17      False
18      False
19      False
20      False
21      False
22      False
23      False
24      False
25      False
26      False
27      False
28      False
29      False
        ...  
3055    False
3056    False
3057    False
3058    False
3059    False
3060    False
3061    False
3062    False
3063    False
3064    False
3065    False
3066    False
3067    False
3068    False
3069    False
3070    False
3071    False
3072    False
3073    False
3074    False
3075    False
3076    False
3077    False
3078    False
3079    False
3080     True
3081    False
3082    False
3083    False
3084    False
Name: STATE_NAME, dtype: bool
</code></pre><p>Then, use that to filter out rows where the condition is true:</p>
<pre><code class="lang-python">data_table[data_table.STATE_NAME == <span class="hljs-string">&apos;Arizona&apos;</span>]
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1707</th>
      <td>Navajo</td>
      <td>Arizona</td>
      <td>04</td>
      <td>017</td>
      <td>04017</td>
      <td>4</td>
      <td>17</td>
      <td>4017</td>
      <td>0</td>
      <td>5.263989</td>
      <td>...</td>
      <td>0.905251</td>
      <td>0.366863</td>
      <td>0.414135</td>
      <td>0.401999</td>
      <td>0.445299</td>
      <td>13.146998</td>
      <td>12.1</td>
      <td>13.762783</td>
      <td>18.033782</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e280080&gt;</td>
    </tr>
    <tr>
      <th>1708</th>
      <td>Coconino</td>
      <td>Arizona</td>
      <td>04</td>
      <td>005</td>
      <td>04005</td>
      <td>4</td>
      <td>5</td>
      <td>4005</td>
      <td>0</td>
      <td>3.185449</td>
      <td>...</td>
      <td>1.469081</td>
      <td>0.301222</td>
      <td>0.377785</td>
      <td>0.381655</td>
      <td>0.403188</td>
      <td>9.475171</td>
      <td>8.5</td>
      <td>11.181563</td>
      <td>15.267643</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2800f0&gt;</td>
    </tr>
    <tr>
      <th>1722</th>
      <td>Mohave</td>
      <td>Arizona</td>
      <td>04</td>
      <td>015</td>
      <td>04015</td>
      <td>4</td>
      <td>15</td>
      <td>4015</td>
      <td>0</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.324075</td>
      <td>0.279339</td>
      <td>0.347150</td>
      <td>0.375790</td>
      <td>0.374383</td>
      <td>11.508554</td>
      <td>4.8</td>
      <td>7.018268</td>
      <td>9.214294</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e280710&gt;</td>
    </tr>
    <tr>
      <th>1726</th>
      <td>Apache</td>
      <td>Arizona</td>
      <td>04</td>
      <td>001</td>
      <td>04001</td>
      <td>4</td>
      <td>1</td>
      <td>4001</td>
      <td>0</td>
      <td>10.951223</td>
      <td>...</td>
      <td>0.162361</td>
      <td>0.395913</td>
      <td>0.450552</td>
      <td>0.431013</td>
      <td>0.489132</td>
      <td>15.014738</td>
      <td>14.6</td>
      <td>18.727548</td>
      <td>22.933635</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2808d0&gt;</td>
    </tr>
    <tr>
      <th>2002</th>
      <td>Yavapai</td>
      <td>Arizona</td>
      <td>04</td>
      <td>025</td>
      <td>04025</td>
      <td>4</td>
      <td>25</td>
      <td>4025</td>
      <td>0</td>
      <td>3.458771</td>
      <td>...</td>
      <td>0.298011</td>
      <td>0.289509</td>
      <td>0.378195</td>
      <td>0.376313</td>
      <td>0.384089</td>
      <td>9.930032</td>
      <td>8.6</td>
      <td>7.516372</td>
      <td>9.483521</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e394518&gt;</td>
    </tr>
    <tr>
      <th>2182</th>
      <td>Gila</td>
      <td>Arizona</td>
      <td>04</td>
      <td>007</td>
      <td>04007</td>
      <td>4</td>
      <td>7</td>
      <td>4007</td>
      <td>0</td>
      <td>6.473749</td>
      <td>...</td>
      <td>0.246171</td>
      <td>0.265294</td>
      <td>0.337519</td>
      <td>0.353848</td>
      <td>0.386976</td>
      <td>10.470261</td>
      <td>8.1</td>
      <td>9.934237</td>
      <td>11.706102</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4500b8&gt;</td>
    </tr>
    <tr>
      <th>2262</th>
      <td>Maricopa</td>
      <td>Arizona</td>
      <td>04</td>
      <td>013</td>
      <td>04013</td>
      <td>4</td>
      <td>13</td>
      <td>4013</td>
      <td>0</td>
      <td>6.179259</td>
      <td>...</td>
      <td>3.499221</td>
      <td>0.277828</td>
      <td>0.352374</td>
      <td>0.366015</td>
      <td>0.372756</td>
      <td>10.642382</td>
      <td>9.8</td>
      <td>11.857260</td>
      <td>14.404902</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e49d438&gt;</td>
    </tr>
    <tr>
      <th>2311</th>
      <td>Greenlee</td>
      <td>Arizona</td>
      <td>04</td>
      <td>011</td>
      <td>04011</td>
      <td>4</td>
      <td>11</td>
      <td>4011</td>
      <td>0</td>
      <td>2.896284</td>
      <td>...</td>
      <td>0.349650</td>
      <td>0.177691</td>
      <td>0.257158</td>
      <td>0.283518</td>
      <td>0.337256</td>
      <td>9.806115</td>
      <td>6.7</td>
      <td>5.295110</td>
      <td>10.453284</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4c1a58&gt;</td>
    </tr>
    <tr>
      <th>2326</th>
      <td>Graham</td>
      <td>Arizona</td>
      <td>04</td>
      <td>009</td>
      <td>04009</td>
      <td>4</td>
      <td>9</td>
      <td>4009</td>
      <td>0</td>
      <td>4.746648</td>
      <td>...</td>
      <td>1.890487</td>
      <td>0.310256</td>
      <td>0.362926</td>
      <td>0.383554</td>
      <td>0.408379</td>
      <td>11.979335</td>
      <td>10.1</td>
      <td>11.961367</td>
      <td>16.129032</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ea128&gt;</td>
    </tr>
    <tr>
      <th>2353</th>
      <td>Pinal</td>
      <td>Arizona</td>
      <td>04</td>
      <td>021</td>
      <td>04021</td>
      <td>4</td>
      <td>21</td>
      <td>4021</td>
      <td>0</td>
      <td>13.828390</td>
      <td>...</td>
      <td>3.134586</td>
      <td>0.304294</td>
      <td>0.369974</td>
      <td>0.361193</td>
      <td>0.400130</td>
      <td>10.822965</td>
      <td>8.8</td>
      <td>10.341699</td>
      <td>15.304144</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ead68&gt;</td>
    </tr>
    <tr>
      <th>2499</th>
      <td>Pima</td>
      <td>Arizona</td>
      <td>04</td>
      <td>019</td>
      <td>04019</td>
      <td>4</td>
      <td>19</td>
      <td>4019</td>
      <td>0</td>
      <td>5.520841</td>
      <td>...</td>
      <td>3.118252</td>
      <td>0.268266</td>
      <td>0.367218</td>
      <td>0.375039</td>
      <td>0.392144</td>
      <td>11.381626</td>
      <td>10.2</td>
      <td>12.689768</td>
      <td>16.163178</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e575e80&gt;</td>
    </tr>
    <tr>
      <th>2514</th>
      <td>Cochise</td>
      <td>Arizona</td>
      <td>04</td>
      <td>003</td>
      <td>04003</td>
      <td>4</td>
      <td>3</td>
      <td>4003</td>
      <td>0</td>
      <td>4.845049</td>
      <td>...</td>
      <td>5.201590</td>
      <td>0.261208</td>
      <td>0.359500</td>
      <td>0.359701</td>
      <td>0.399208</td>
      <td>10.197573</td>
      <td>8.7</td>
      <td>9.912732</td>
      <td>13.733872</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e59b550&gt;</td>
    </tr>
    <tr>
      <th>2615</th>
      <td>Santa Cruz</td>
      <td>Arizona</td>
      <td>04</td>
      <td>023</td>
      <td>04023</td>
      <td>4</td>
      <td>23</td>
      <td>4023</td>
      <td>0</td>
      <td>9.252406</td>
      <td>...</td>
      <td>0.326863</td>
      <td>0.327130</td>
      <td>0.396807</td>
      <td>0.393240</td>
      <td>0.413795</td>
      <td>19.007213</td>
      <td>14.7</td>
      <td>15.690913</td>
      <td>18.272244</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e60a2e8&gt;</td>
    </tr>
    <tr>
      <th>3080</th>
      <td>La Paz</td>
      <td>Arizona</td>
      <td>04</td>
      <td>012</td>
      <td>04012</td>
      <td>4</td>
      <td>12</td>
      <td>4012</td>
      <td>0</td>
      <td>5.046682</td>
      <td>...</td>
      <td>2.628811</td>
      <td>0.271556</td>
      <td>0.364110</td>
      <td>0.372662</td>
      <td>0.405743</td>
      <td>9.216414</td>
      <td>8.0</td>
      <td>9.296093</td>
      <td>12.379134</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e79bb70&gt;</td>
    </tr>
  </tbody>
</table>
<p>14 rows &#xD7; 70 columns</p>
</div>



<p>We might need this behind the scenes knowledge when we want to chain together conditions, or when we need to do spatial queries. </p>
<p>This is because spatial queries are somewhat more complex. Let&apos;s say, for example, we want all of the counties in the US to the West of <code>-121</code> longitude. We need a way to express that question. Ideally, we want something like:</p>
<pre><code>SELECT
        *
FROM
        data_table
WHERE
        x_centroid &lt; -121
</code></pre><p>So, let&apos;s refer to an arbitrary polygon in the the dataframe&apos;s geometry column as <code>poly</code>. The centroid of a PySAL polygon is stored as an <code>(X,Y)</code> pair, so the longitude is the first element of the pair, <code>poly.centroid[0]</code>. </p>
<p>Then, applying this condition to each geometry, we get the same kind of filter we used above to grab only counties in Arizona:</p>
<pre><code class="lang-python">data_table.geometry.apply(<span class="hljs-keyword">lambda</span> x: x.centroid[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">-121</span>)\
                   .head()
</code></pre>
<pre><code>0    False
1    False
2    False
3    False
4    False
Name: geometry, dtype: bool
</code></pre><p>If we use this as a filter on the table, we can get only the rows that match that condition, just like we did for the <code>STATE_NAME</code> query:</p>
<pre><code class="lang-python">data_table[data_table.geometry.apply(<span class="hljs-keyword">lambda</span> x: x.centroid[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">-119</span>)].head()
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>Okanogan</td>
      <td>Washington</td>
      <td>53</td>
      <td>047</td>
      <td>53047</td>
      <td>53</td>
      <td>47</td>
      <td>53047</td>
      <td>0</td>
      <td>2.612330</td>
      <td>...</td>
      <td>0.155922</td>
      <td>0.258540</td>
      <td>0.371218</td>
      <td>0.381240</td>
      <td>0.394519</td>
      <td>9.039900</td>
      <td>8.1</td>
      <td>10.084926</td>
      <td>12.840340</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10dadd5c0&gt;</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Whatcom</td>
      <td>Washington</td>
      <td>53</td>
      <td>073</td>
      <td>53073</td>
      <td>53</td>
      <td>73</td>
      <td>53073</td>
      <td>0</td>
      <td>1.422131</td>
      <td>...</td>
      <td>0.508687</td>
      <td>0.247630</td>
      <td>0.346935</td>
      <td>0.369436</td>
      <td>0.358418</td>
      <td>9.174415</td>
      <td>7.1</td>
      <td>9.718054</td>
      <td>11.135022</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10df05080&gt;</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Skagit</td>
      <td>Washington</td>
      <td>53</td>
      <td>057</td>
      <td>53057</td>
      <td>53</td>
      <td>57</td>
      <td>53057</td>
      <td>0</td>
      <td>2.596560</td>
      <td>...</td>
      <td>0.351958</td>
      <td>0.239346</td>
      <td>0.344830</td>
      <td>0.364623</td>
      <td>0.362265</td>
      <td>8.611518</td>
      <td>7.9</td>
      <td>10.480031</td>
      <td>11.382484</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10df05240&gt;</td>
    </tr>
    <tr>
      <th>42</th>
      <td>Chelan</td>
      <td>Washington</td>
      <td>53</td>
      <td>007</td>
      <td>53007</td>
      <td>53</td>
      <td>7</td>
      <td>53007</td>
      <td>0</td>
      <td>4.908698</td>
      <td>...</td>
      <td>0.153110</td>
      <td>0.246292</td>
      <td>0.367681</td>
      <td>0.374505</td>
      <td>0.383486</td>
      <td>8.787907</td>
      <td>8.1</td>
      <td>9.968454</td>
      <td>12.236493</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10df05710&gt;</td>
    </tr>
    <tr>
      <th>44</th>
      <td>Clallam</td>
      <td>Washington</td>
      <td>53</td>
      <td>009</td>
      <td>53009</td>
      <td>53</td>
      <td>9</td>
      <td>53009</td>
      <td>0</td>
      <td>3.330891</td>
      <td>...</td>
      <td>0.568504</td>
      <td>0.240573</td>
      <td>0.349320</td>
      <td>0.361619</td>
      <td>0.366854</td>
      <td>8.788882</td>
      <td>6.5</td>
      <td>9.660900</td>
      <td>12.281690</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10df057f0&gt;</td>
    </tr>
  </tbody>
</table>
<p>5 rows &#xD7; 70 columns</p>
</div>




<pre><code class="lang-python">len(data_table[data_table.geometry.apply(<span class="hljs-keyword">lambda</span> x: x.centroid[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">-119</span>)]) <span class="hljs-comment">#how many west of -119?</span>
</code></pre>
<pre><code>109
</code></pre><h2 id="other-types-of-spatial-queries">Other types of spatial queries</h2>
<p>Everybody knows the following statements are true:</p>
<ol>
<li>If you head directly west from Reno, Nevada, you will shortly enter California.</li>
<li>San Diego is in California.</li>
</ol>
<p>But what does this tell us about the location of San Diego relative to Reno?</p>
<p>Or for that matter, how many counties in California are to the east of Reno?</p>
<pre><code class="lang-python">geom = data_table.query(<span class="hljs-string">&apos;(NAME == &quot;Washoe&quot;) &amp; (STATE_NAME == &quot;Nevada&quot;)&apos;</span>).geometry
</code></pre>
<pre><code class="lang-python">lon,lat = geom.values[<span class="hljs-number">0</span>].centroid
</code></pre>
<pre><code class="lang-python">lon
</code></pre>
<pre><code>-119.6555030699793
</code></pre><pre><code class="lang-python">cal_counties = data_table.query(<span class="hljs-string">&apos;(STATE_NAME==&quot;California&quot;)&apos;</span>)
</code></pre>
<pre><code class="lang-python">cal_counties[cal_counties.geometry.apply(<span class="hljs-keyword">lambda</span> x: x.centroid[<span class="hljs-number">0</span>] &gt; lon)]
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1312</th>
      <td>Mono</td>
      <td>California</td>
      <td>06</td>
      <td>051</td>
      <td>06051</td>
      <td>6</td>
      <td>51</td>
      <td>6051</td>
      <td>0</td>
      <td>15.062509</td>
      <td>...</td>
      <td>0.431900</td>
      <td>0.229888</td>
      <td>0.327520</td>
      <td>0.388414</td>
      <td>0.366316</td>
      <td>6.743421</td>
      <td>6.6</td>
      <td>8.187135</td>
      <td>10.083699</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10dfd5e48&gt;</td>
    </tr>
    <tr>
      <th>1591</th>
      <td>Fresno</td>
      <td>California</td>
      <td>06</td>
      <td>019</td>
      <td>06019</td>
      <td>6</td>
      <td>19</td>
      <td>6019</td>
      <td>0</td>
      <td>5.192037</td>
      <td>...</td>
      <td>5.007266</td>
      <td>0.286651</td>
      <td>0.379884</td>
      <td>0.394981</td>
      <td>0.412947</td>
      <td>11.788963</td>
      <td>11.8</td>
      <td>13.998747</td>
      <td>18.523541</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e0ecc50&gt;</td>
    </tr>
    <tr>
      <th>1620</th>
      <td>Inyo</td>
      <td>California</td>
      <td>06</td>
      <td>027</td>
      <td>06027</td>
      <td>6</td>
      <td>27</td>
      <td>6027</td>
      <td>0</td>
      <td>8.558713</td>
      <td>...</td>
      <td>0.432143</td>
      <td>0.242293</td>
      <td>0.334361</td>
      <td>0.353784</td>
      <td>0.378516</td>
      <td>9.676365</td>
      <td>8.1</td>
      <td>8.480065</td>
      <td>12.067279</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e220940&gt;</td>
    </tr>
    <tr>
      <th>1765</th>
      <td>Tulare</td>
      <td>California</td>
      <td>06</td>
      <td>107</td>
      <td>06107</td>
      <td>6</td>
      <td>107</td>
      <td>6107</td>
      <td>0</td>
      <td>3.364944</td>
      <td>...</td>
      <td>1.480503</td>
      <td>0.303303</td>
      <td>0.380229</td>
      <td>0.395059</td>
      <td>0.410811</td>
      <td>10.398757</td>
      <td>9.5</td>
      <td>11.957928</td>
      <td>16.303423</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e2a4a58&gt;</td>
    </tr>
    <tr>
      <th>1956</th>
      <td>Kern</td>
      <td>California</td>
      <td>06</td>
      <td>029</td>
      <td>06029</td>
      <td>6</td>
      <td>29</td>
      <td>6029</td>
      <td>0</td>
      <td>6.393044</td>
      <td>...</td>
      <td>5.544117</td>
      <td>0.273083</td>
      <td>0.364603</td>
      <td>0.380617</td>
      <td>0.395393</td>
      <td>10.225236</td>
      <td>10.4</td>
      <td>12.037755</td>
      <td>16.118827</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e348fd0&gt;</td>
    </tr>
    <tr>
      <th>1957</th>
      <td>San Bernardino</td>
      <td>California</td>
      <td>06</td>
      <td>071</td>
      <td>06071</td>
      <td>6</td>
      <td>71</td>
      <td>6071</td>
      <td>0</td>
      <td>3.243373</td>
      <td>...</td>
      <td>8.103188</td>
      <td>0.259038</td>
      <td>0.350927</td>
      <td>0.362389</td>
      <td>0.372659</td>
      <td>9.857519</td>
      <td>10.0</td>
      <td>12.999831</td>
      <td>15.403925</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e36f080&gt;</td>
    </tr>
    <tr>
      <th>2117</th>
      <td>Ventura</td>
      <td>California</td>
      <td>06</td>
      <td>111</td>
      <td>06111</td>
      <td>6</td>
      <td>111</td>
      <td>6111</td>
      <td>0</td>
      <td>3.180374</td>
      <td>...</td>
      <td>2.336118</td>
      <td>0.259643</td>
      <td>0.325908</td>
      <td>0.350430</td>
      <td>0.329175</td>
      <td>10.304761</td>
      <td>8.9</td>
      <td>11.047165</td>
      <td>12.044930</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e40c390&gt;</td>
    </tr>
    <tr>
      <th>2255</th>
      <td>Riverside</td>
      <td>California</td>
      <td>06</td>
      <td>065</td>
      <td>06065</td>
      <td>6</td>
      <td>65</td>
      <td>6065</td>
      <td>0</td>
      <td>4.898903</td>
      <td>...</td>
      <td>5.433210</td>
      <td>0.284000</td>
      <td>0.376737</td>
      <td>0.383226</td>
      <td>0.368177</td>
      <td>9.769959</td>
      <td>9.2</td>
      <td>11.145612</td>
      <td>12.678340</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e49d128&gt;</td>
    </tr>
    <tr>
      <th>2279</th>
      <td>Orange</td>
      <td>California</td>
      <td>06</td>
      <td>059</td>
      <td>06059</td>
      <td>6</td>
      <td>59</td>
      <td>6059</td>
      <td>0</td>
      <td>2.083555</td>
      <td>...</td>
      <td>1.770587</td>
      <td>0.255864</td>
      <td>0.316731</td>
      <td>0.355117</td>
      <td>0.330447</td>
      <td>8.802545</td>
      <td>9.1</td>
      <td>12.405423</td>
      <td>12.974648</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e49dc18&gt;</td>
    </tr>
    <tr>
      <th>2344</th>
      <td>San Diego</td>
      <td>California</td>
      <td>06</td>
      <td>073</td>
      <td>06073</td>
      <td>6</td>
      <td>73</td>
      <td>6073</td>
      <td>0</td>
      <td>2.387842</td>
      <td>...</td>
      <td>6.377301</td>
      <td>0.269147</td>
      <td>0.352428</td>
      <td>0.382815</td>
      <td>0.368301</td>
      <td>11.425041</td>
      <td>11.5</td>
      <td>14.384523</td>
      <td>15.489702</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4ea908&gt;</td>
    </tr>
    <tr>
      <th>2351</th>
      <td>Los Angeles</td>
      <td>California</td>
      <td>06</td>
      <td>037</td>
      <td>06037</td>
      <td>6</td>
      <td>37</td>
      <td>6037</td>
      <td>0</td>
      <td>4.564947</td>
      <td>...</td>
      <td>11.203381</td>
      <td>0.267207</td>
      <td>0.353837</td>
      <td>0.402031</td>
      <td>0.392669</td>
      <td>13.071850</td>
      <td>13.4</td>
      <td>17.767317</td>
      <td>18.808224</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4eac18&gt;</td>
    </tr>
    <tr>
      <th>2358</th>
      <td>Imperial</td>
      <td>California</td>
      <td>06</td>
      <td>025</td>
      <td>06025</td>
      <td>6</td>
      <td>25</td>
      <td>6025</td>
      <td>0</td>
      <td>4.160599</td>
      <td>...</td>
      <td>2.398836</td>
      <td>0.286568</td>
      <td>0.374913</td>
      <td>0.397430</td>
      <td>0.426348</td>
      <td>11.466417</td>
      <td>9.7</td>
      <td>12.590249</td>
      <td>17.243741</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e4eaf98&gt;</td>
    </tr>
  </tbody>
</table>
<p>12 rows &#xD7; 70 columns</p>
</div>




<pre><code class="lang-python">len(cal_counties)
</code></pre>
<pre><code>58
</code></pre><p>This works on any type of spatial query. </p>
<p>For instance, if we wanted to find all of the counties that are within a threshold distance from an observation&apos;s centroid, we can do it in the following way. </p>
<p>But first, we need to handle distance calculations on the earth&apos;s surface.</p>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> math <span class="hljs-keyword">import</span> radians, sin, cos, sqrt, asin

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gcd</span><span class="hljs-params">(loc1, loc2, R=<span class="hljs-number">3961</span>)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;Great circle distance via Haversine formula

    Parameters
    ----------

    loc1: tuple (long, lat in decimal degrees)

    loc2: tuple (long, lat in decimal degrees)

    R: Radius of the earth (3961 miles, 6367 km)

    Returns
    -------
    great circle distance between loc1 and loc2 in units of R


    Notes
    ------
    Does not take into account non-spheroidal shape of the Earth



    &gt;&gt;&gt; san_diego = -117.1611, 32.7157
    &gt;&gt;&gt; austin = -97.7431, 30.2672
    &gt;&gt;&gt; gcd(san_diego, austin)
    1155.474644164695


    &quot;&quot;&quot;</span>
    lon1, lat1 = loc1
    lon2, lat2 = loc2
    dLat = radians(lat2 - lat1)
    dLon = radians(lon2 - lon1)
    lat1 = radians(lat1)
    lat2 = radians(lat2)

    a = sin(dLat/<span class="hljs-number">2</span>)**<span class="hljs-number">2</span> + cos(lat1)*cos(lat2)*sin(dLon/<span class="hljs-number">2</span>)**<span class="hljs-number">2</span>
    c = <span class="hljs-number">2</span>*asin(sqrt(a))

    <span class="hljs-keyword">return</span> R * c

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gcdm</span><span class="hljs-params">(loc1, loc2)</span>:</span>
    <span class="hljs-keyword">return</span> gcd(loc1, loc2)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gcdk</span><span class="hljs-params">(loc1, loc2)</span>:</span>
    <span class="hljs-keyword">return</span> gcd(loc1, loc2, <span class="hljs-number">6367</span> )
</code></pre>
<pre><code class="lang-python">san_diego = <span class="hljs-number">-117.1611</span>, <span class="hljs-number">32.7157</span>
austin = <span class="hljs-number">-97.7431</span>, <span class="hljs-number">30.2672</span>
gcd(san_diego, austin)
</code></pre>
<pre><code>1155.474644164695
</code></pre><pre><code class="lang-python">gcdk(san_diego, austin)
</code></pre>
<pre><code>1857.3357887898544
</code></pre><pre><code class="lang-python">loc1 = (<span class="hljs-number">-117.1611</span>, <span class="hljs-number">0.0</span>)
loc2 = (<span class="hljs-number">-118.1611</span>, <span class="hljs-number">0.0</span>)
gcd(loc1, loc2)
</code></pre>
<pre><code>69.13249167149539
</code></pre><pre><code class="lang-python">loc1 = (<span class="hljs-number">-117.1611</span>, <span class="hljs-number">45.0</span>)
loc2 = (<span class="hljs-number">-118.1611</span>, <span class="hljs-number">45.0</span>)
gcd(loc1, loc2)
</code></pre>
<pre><code>48.88374342930467
</code></pre><pre><code class="lang-python">loc1 = (<span class="hljs-number">-117.1611</span>, <span class="hljs-number">89.0</span>)
loc2 = (<span class="hljs-number">-118.1611</span>, <span class="hljs-number">89.0</span>)
gcd(loc1, loc2)
</code></pre>
<pre><code>1.2065130336642724
</code></pre><pre><code class="lang-python">lats = range(<span class="hljs-number">0</span>, <span class="hljs-number">91</span>)
onedeglon = [ gcd((<span class="hljs-number">-117.1611</span>,lat),(<span class="hljs-number">-118.1611</span>,lat)) <span class="hljs-keyword">for</span> lat <span class="hljs-keyword">in</span> lats]
</code></pre>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
%matplotlib inline
plt.plot(lats, onedeglon)
plt.ylabel(<span class="hljs-string">&apos;miles&apos;</span>)
plt.xlabel(<span class="hljs-string">&apos;degree of latitude&apos;</span>)
plt.title(<span class="hljs-string">&apos;Length of a degree of longitude&apos;</span>)
</code></pre>
<pre><code>&lt;matplotlib.text.Text at 0x114174470&gt;
</code></pre><p><img src="01_data_processing_files/01_data_processing_87_1.png" alt="png"></p>
<pre><code class="lang-python">san_diego = <span class="hljs-number">-117.1611</span>, <span class="hljs-number">32.7157</span>
austin = <span class="hljs-number">-97.7431</span>, <span class="hljs-number">30.2672</span>
gcd(san_diego, austin)
</code></pre>
<pre><code>1155.474644164695
</code></pre><p>Now we can use our distance function to pose distance-related queries on our data table.</p>
<pre><code class="lang-python"><span class="hljs-comment"># Find all the counties with centroids within 50 miles of Austin</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">near_target_point</span><span class="hljs-params">(polygon, target=austin, threshold=<span class="hljs-number">50</span>)</span>:</span>
    <span class="hljs-keyword">return</span> gcd(polygon.centroid, target) &lt; threshold 

data_table[data_table.geometry.apply(near_target_point)]
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>STATE_NAME</th>
      <th>STATE_FIPS</th>
      <th>CNTY_FIPS</th>
      <th>FIPS</th>
      <th>STFIPS</th>
      <th>COFIPS</th>
      <th>FIPSNO</th>
      <th>SOUTH</th>
      <th>HR60</th>
      <th>...</th>
      <th>BLK90</th>
      <th>GI59</th>
      <th>GI69</th>
      <th>GI79</th>
      <th>GI89</th>
      <th>FH60</th>
      <th>FH70</th>
      <th>FH80</th>
      <th>FH90</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2698</th>
      <td>Burnet</td>
      <td>Texas</td>
      <td>48</td>
      <td>053</td>
      <td>48053</td>
      <td>48</td>
      <td>53</td>
      <td>48053</td>
      <td>1</td>
      <td>0.000000</td>
      <td>...</td>
      <td>1.186224</td>
      <td>0.327508</td>
      <td>0.449285</td>
      <td>0.385079</td>
      <td>0.405890</td>
      <td>10.774142</td>
      <td>6.5</td>
      <td>7.115629</td>
      <td>10.568742</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6567f0&gt;</td>
    </tr>
    <tr>
      <th>2716</th>
      <td>Williamson</td>
      <td>Texas</td>
      <td>48</td>
      <td>491</td>
      <td>48491</td>
      <td>48</td>
      <td>491</td>
      <td>48491</td>
      <td>1</td>
      <td>9.511852</td>
      <td>...</td>
      <td>4.916482</td>
      <td>0.363603</td>
      <td>0.379902</td>
      <td>0.341976</td>
      <td>0.345201</td>
      <td>13.532731</td>
      <td>9.0</td>
      <td>7.582572</td>
      <td>12.032589</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e656fd0&gt;</td>
    </tr>
    <tr>
      <th>2742</th>
      <td>Travis</td>
      <td>Texas</td>
      <td>48</td>
      <td>453</td>
      <td>48453</td>
      <td>48</td>
      <td>453</td>
      <td>48453</td>
      <td>1</td>
      <td>4.242561</td>
      <td>...</td>
      <td>10.959791</td>
      <td>0.299292</td>
      <td>0.372293</td>
      <td>0.378953</td>
      <td>0.388149</td>
      <td>12.976379</td>
      <td>10.9</td>
      <td>14.459691</td>
      <td>17.307113</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e67eba8&gt;</td>
    </tr>
    <tr>
      <th>2751</th>
      <td>Lee</td>
      <td>Texas</td>
      <td>48</td>
      <td>287</td>
      <td>48287</td>
      <td>48</td>
      <td>287</td>
      <td>48287</td>
      <td>1</td>
      <td>7.449622</td>
      <td>...</td>
      <td>13.847829</td>
      <td>0.376002</td>
      <td>0.433132</td>
      <td>0.394000</td>
      <td>0.394959</td>
      <td>12.305699</td>
      <td>10.1</td>
      <td>8.875542</td>
      <td>10.530896</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e67eef0&gt;</td>
    </tr>
    <tr>
      <th>2754</th>
      <td>Blanco</td>
      <td>Texas</td>
      <td>48</td>
      <td>031</td>
      <td>48031</td>
      <td>48</td>
      <td>31</td>
      <td>48031</td>
      <td>1</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.937709</td>
      <td>0.369814</td>
      <td>0.436449</td>
      <td>0.394609</td>
      <td>0.394414</td>
      <td>9.365854</td>
      <td>6.0</td>
      <td>8.074074</td>
      <td>9.080119</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6aa160&gt;</td>
    </tr>
    <tr>
      <th>2762</th>
      <td>Bastrop</td>
      <td>Texas</td>
      <td>48</td>
      <td>021</td>
      <td>48021</td>
      <td>48</td>
      <td>21</td>
      <td>48021</td>
      <td>1</td>
      <td>3.938946</td>
      <td>...</td>
      <td>11.792071</td>
      <td>0.370264</td>
      <td>0.419933</td>
      <td>0.390927</td>
      <td>0.380907</td>
      <td>14.747191</td>
      <td>12.5</td>
      <td>10.559006</td>
      <td>12.281387</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6aa518&gt;</td>
    </tr>
    <tr>
      <th>2769</th>
      <td>Hays</td>
      <td>Texas</td>
      <td>48</td>
      <td>209</td>
      <td>48209</td>
      <td>48</td>
      <td>209</td>
      <td>48209</td>
      <td>1</td>
      <td>5.016555</td>
      <td>...</td>
      <td>3.383424</td>
      <td>0.385061</td>
      <td>0.424973</td>
      <td>0.378992</td>
      <td>0.372266</td>
      <td>13.064187</td>
      <td>9.4</td>
      <td>10.003691</td>
      <td>10.337188</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6aa908&gt;</td>
    </tr>
    <tr>
      <th>2795</th>
      <td>Caldwell</td>
      <td>Texas</td>
      <td>48</td>
      <td>055</td>
      <td>48055</td>
      <td>48</td>
      <td>55</td>
      <td>48055</td>
      <td>1</td>
      <td>9.677544</td>
      <td>...</td>
      <td>10.704001</td>
      <td>0.380080</td>
      <td>0.412614</td>
      <td>0.410802</td>
      <td>0.413940</td>
      <td>15.229616</td>
      <td>10.5</td>
      <td>12.894034</td>
      <td>17.191502</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6d04a8&gt;</td>
    </tr>
    <tr>
      <th>2798</th>
      <td>Comal</td>
      <td>Texas</td>
      <td>48</td>
      <td>091</td>
      <td>48091</td>
      <td>48</td>
      <td>91</td>
      <td>48091</td>
      <td>1</td>
      <td>3.359538</td>
      <td>...</td>
      <td>0.854684</td>
      <td>0.274182</td>
      <td>0.359174</td>
      <td>0.375810</td>
      <td>0.380032</td>
      <td>11.315107</td>
      <td>7.6</td>
      <td>8.693149</td>
      <td>9.104427</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6d05f8&gt;</td>
    </tr>
    <tr>
      <th>2808</th>
      <td>Guadalupe</td>
      <td>Texas</td>
      <td>48</td>
      <td>187</td>
      <td>48187</td>
      <td>48</td>
      <td>187</td>
      <td>48187</td>
      <td>1</td>
      <td>5.743759</td>
      <td>...</td>
      <td>5.649500</td>
      <td>0.340374</td>
      <td>0.388821</td>
      <td>0.354559</td>
      <td>0.378073</td>
      <td>11.758921</td>
      <td>9.6</td>
      <td>10.418149</td>
      <td>12.918448</td>
      <td>&lt;pysal.cg.shapes.Polygon object at 0x10e6d0a58&gt;</td>
    </tr>
  </tbody>
</table>
<p>10 rows &#xD7; 70 columns</p>
</div>



<h3 id="moving-in-and-out-of-the-dataframe">Moving in and out of the dataframe</h3>
<p>Most things in PySAL will be explicit about what type their input should be. Most of the time, PySAL functions require either lists or arrays. This is why the file-handler methods are the default IO method in PySAL: the rest of the computational tools are built around their datatypes. </p>
<p>However, it is very easy to get the correct datatype from Pandas using the <code>values</code> and <code>tolist</code> commands. </p>
<p><code>tolist()</code> will convert its entries to a list. But, it can only be called on individual columns (called <code>Series</code> in <code>pandas</code> documentation).</p>
<p>So, to turn the <code>NAME</code> column into a list:</p>
<pre><code class="lang-python">data_table.NAME.tolist()[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]
</code></pre>
<pre><code>[&apos;Lake of the Woods&apos;,
 &apos;Ferry&apos;,
 &apos;Stevens&apos;,
 &apos;Okanogan&apos;,
 &apos;Pend Oreille&apos;,
 &apos;Boundary&apos;,
 &apos;Lincoln&apos;,
 &apos;Flathead&apos;,
 &apos;Glacier&apos;,
 &apos;Toole&apos;]
</code></pre><p>To extract many columns, you must select the columns you want and call their <code>.values</code> attribute. </p>
<p>If we were interested in grabbing all of the <code>HR</code> variables in the dataframe, we could first select those column names:</p>
<pre><code class="lang-python">HRs = [col <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> data_table.columns <span class="hljs-keyword">if</span> col.startswith(<span class="hljs-string">&apos;HR&apos;</span>)]
HRs
</code></pre>
<pre><code>[&apos;HR60&apos;, &apos;HR70&apos;, &apos;HR80&apos;, &apos;HR90&apos;]
</code></pre><p>We can use this to focus only on the columns we want:</p>
<pre><code class="lang-python">data_table[HRs].head()
</code></pre>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>HR60</th>
      <th>HR70</th>
      <th>HR80</th>
      <th>HR90</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>8.855827</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>17.208742</td>
      <td>15.885624</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.863863</td>
      <td>1.915158</td>
      <td>3.450775</td>
      <td>6.462453</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.612330</td>
      <td>1.288643</td>
      <td>3.263814</td>
      <td>6.996502</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>7.770008</td>
      <td>7.478033</td>
    </tr>
  </tbody>
</table>
</div>



<p>With this, calling <code>.values</code> gives an array containing all of the entries in this subset of the table:</p>
<pre><code class="lang-python">data_table[[<span class="hljs-string">&apos;HR90&apos;</span>, <span class="hljs-string">&apos;HR80&apos;</span>]].values
</code></pre>
<pre><code>array([[  0.        ,   8.85582713],
       [ 15.88562351,  17.20874204],
       [  6.46245315,   3.4507747 ],
       ..., 
       [  4.36732988,   5.2803488 ],
       [  3.72771194,   3.00003   ],
       [  2.04885495,   1.19474313]])
</code></pre><p>Using the PySAL pdio tools means that if you&apos;re comfortable with working in Pandas, you can continue to do so. </p>
<p>If you&apos;re more comfortable using Numpy or raw Python to do your data processing, PySAL&apos;s IO tools naturally support this. </p>
<h2 id="exercises">Exercises</h2>
<ol>
<li>Find the county with the western most centroid that is within 1000 miles of Austin.</li>
<li>Find the distance between Austin and that centroid.<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>636f30a097e66b464102c7a639d7f51915ce5edd</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</li>
</ol>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../content/part1/" class="navigation navigation-prev " aria-label="Previous page: Part I">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="02_geovisualization.html" class="navigation navigation-next " aria-label="Next page: Geovisualization">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Spatial data processing with PySAL","level":"1.7.1","depth":2,"next":{"title":"Geovisualization","level":"1.7.2","depth":2,"path":"ipynb_md/02_geovisualization.md","ref":"ipynb_md/02_geovisualization.md","articles":[]},"previous":{"title":"Part I","level":"1.7","depth":1,"path":"content/part1/README.md","ref":"content/part1/README.md","articles":[{"title":"Spatial data processing with PySAL","level":"1.7.1","depth":2,"path":"ipynb_md/01_data_processing.md","ref":"ipynb_md/01_data_processing.md","articles":[]},{"title":"Geovisualization","level":"1.7.2","depth":2,"path":"ipynb_md/02_geovisualization.md","ref":"ipynb_md/02_geovisualization.md","articles":[]},{"title":"Spatial weights in PySAL","level":"1.7.3","depth":2,"path":"ipynb_md/03_spatial_weights.md","ref":"ipynb_md/03_spatial_weights.md","articles":[]},{"title":"ESDA with PySAL","level":"1.7.4","depth":2,"path":"ipynb_md/04_esda.md","ref":"ipynb_md/04_esda.md","articles":[]},{"title":"Space-time analysis","level":"1.7.5","depth":2,"path":"ipynb_md/05_spatial_dynamics.md","ref":"ipynb_md/05_spatial_dynamics.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["katex-dev"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"katex-dev":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Serif","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Geographic Data Science with PySAL and the pydata stack","gitbook":">=3.0.0","description":"Booklet with material for the workshop at Scipy'16"},"file":{"path":"ipynb_md/01_data_processing.md","mtime":"2021-03-07T15:05:01.597Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-03-07T15:10:48.279Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

